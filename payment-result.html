<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>支付结果 - 微信推送配置</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { 
            padding-top: 50px; 
            background-color: #f8f9fa; 
            font-family: 'Microsoft YaHei', sans-serif;
        }
        .result-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        .success-icon {
            color: #28a745;
            font-size: 80px;
            margin-bottom: 20px;
        }
        .error-icon {
            color: #dc3545;
            font-size: 80px;
            margin-bottom: 20px;
        }
        .loading-spinner {
            width: 3rem; 
            height: 3rem;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="result-container">
            <div id="loadingSection">
                <div class="spinner-border text-primary loading-spinner" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <h2>正在处理支付结果...</h2>
                <p class="text-muted">请稍候，系统正在确认您的支付状态</p>
            </div>
            
            <div id="successSection" style="display:none;">
                <div class="success-icon">✓</div>
                <h2>支付成功！</h2>
                <p>您的微信推送服务已开通</p>
                <p class="text-muted mb-4">感谢您的支持，您现在可以开始使用所有功能</p>
                <a href="/" class="btn btn-primary btn-lg">返回配置页面</a>
            </div>
            
            <div id="errorSection" style="display:none;">
                <div class="error-icon">✗</div>
                <h2>处理支付结果时出错</h2>
                <p id="errorMessage" class="text-danger">未能确认支付状态，请联系客服</p>
                <a href="/" class="btn btn-outline-secondary mt-3">返回首页</a>
            </div>
        </div>
    </div>

    <script>
        // 获取URL参数
        function getQueryParam(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }
        
        // 检查支付状态
        async function checkPaymentStatus() {
            try {
                const tradeNo = getQueryParam('trade_no');
                const outTradeNo = getQueryParam('out_trade_no');
                const tradeStatus = getQueryParam('trade_status');
                
                // 如果URL包含支付状态参数，直接处理
                if (tradeStatus === 'TRADE_SUCCESS') {
                    showSuccess();
                    return;
                }
                
                // 否则查询订单状态
                if (outTradeNo) {
                    const response = await fetch(`/api/payment/check-status?order_id=${outTradeNo}`);
                    const result = await response.json();
                    
                    if (result.success && result.status === 'paid') {
                        showSuccess();
                    } else {
                        // 启动轮询
                        startPolling(outTradeNo);
                    }
                } else {
                    showError('无法获取订单信息');
                }
            } catch (error) {
                console.error('检查支付状态出错:', error);
                showError('检查支付状态出错: ' + error.message);
            }
        }
        
        // 开始轮询支付状态
        function startPolling(orderId) {
            let pollCount = 0;
            const maxPolls = 10;
            
            const pollTimer = setInterval(async () => {
                try {
                    pollCount++;
                    
                    const response = await fetch(`/api/payment/check-status?order_id=${orderId}`);
                    const result = await response.json();
                    
                    if (result.success && result.status === 'paid') {
                        clearInterval(pollTimer);
                        showSuccess();
                        return;
                    }
                    
                    if (pollCount >= maxPolls) {
                        clearInterval(pollTimer);
                        showError('查询支付结果超时，如您已完成支付，请刷新页面或联系客服');
                    }
                } catch (error) {
                    console.error('轮询支付状态出错:', error);
                    clearInterval(pollTimer);
                    showError('查询支付状态出错: ' + error.message);
                }
            }, 3000);
        }
        
        function showSuccess() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('successSection').style.display = 'block';
            
            // 记录登录状态
            const phone = sessionStorage.getItem('pendingPhone');
            if (phone) {
                localStorage.setItem('loggedInUser', phone);
            }
            
            // 清除临时会话数据
            sessionStorage.removeItem('pendingConfig');
            sessionStorage.removeItem('pendingPhone');
            sessionStorage.removeItem('pendingPassword');
            sessionStorage.removeItem('pendingPlan');
            sessionStorage.removeItem('currentOrderId');
        }
        
        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }
        
        // 页面加载时检查支付状态
        window.addEventListener('DOMContentLoaded', checkPaymentStatus);
    </script>
</body>
</html> 
