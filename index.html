<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信早安推送配置</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .container { max-width: 700px; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .form-label { font-weight: bold; }
        .alert { margin-top: 20px; }
        .required::after { content: '*'; color: red; margin-left: 2px; }
        /* 新增样式 */
        .auth-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .config-section { display: none; /* 默认隐藏配置区域 */ }
        .user-status { margin-bottom: 15px; font-style: italic; }
        .tutorial-link { margin-bottom: 20px; padding: 10px; background-color: #e9f5ff; border: 1px solid #b3d7ff; border-radius: 5px; }
        .payment-modal-body { /* 支付模态框样式 */ }
        .plan-option { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; }
        .plan-option.selected { border-color: #0d6efd; background-color: #e7f1ff; }
        .plan-option h5 { margin-top: 0; }
        .form-section {
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            padding: 25px;
            background-color: #fff;
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            color: #3a5a78;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
        }
        
        .form-label.required:after {
            content: "*";
            color: red;
            margin-left: 4px;
        }
        
        .btn-primary {
            background-color: #3a5a78;
            border-color: #3a5a78;
        }
        
        .btn-info {
            background-color: #5bc0de;
            border-color: #5bc0de;
            color: white;
        }
        
        .alert-custom-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .alert-custom-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
    <!-- Google Analytics 代码 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=YOUR_ANALYTICS_ID"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'YOUR_ANALYTICS_ID');
    </script>
    <!-- 百度统计代码 -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?YOUR_SITE_ID";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body>
    <div class="container">
        <div class="alert alert-warning mb-4 border-left border-warning" style="border-left: 5px solid #ffc107; font-size: 1.1rem;">
            <h4 class="alert-heading text-center mb-3"><i class="bi bi-exclamation-triangle-fill me-2"></i>重要使用说明</h4>
            <p>使用前请务必阅读<a href="https://bcn1jsdnj3t6.feishu.cn/wiki/DRsNwylmAiJxVokNmfnczd5XnMa" class="alert-link" target="_blank">详细使用教程</a>，了解各项配置含义以及获取方法！</p>
            <hr>
            <ol class="mb-0">
                <li>您需要<strong>先测试发送</strong>确认配置正确，再保存配置</li>
                <li>保存成功后，系统会<strong>每天自动发送</strong>天气、纪念日等信息</li>
                <li>请确保带<strong style="color: red;">*</strong>号的必填信息准确无误，特别是<strong>AppID和AppSecret</strong></li>
            </ol>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>微信推送配置</h2>
        </div>
        
        <!-- 使用前必看教程 -->
        <div class="tutorial-link">
            <strong>重要提示：</strong> 使用前请务必查看 <a href="https://bcn1jsdnj3t6.feishu.cn/wiki/DRsNwylmAiJxVokNmfnczd5XnMa" target="_blank" rel="noopener noreferrer">详细使用教程</a>，了解各项配置含义及获取方法！
                </div>
                
        <!-- 用户认证表单 -->
        <div id="authForm" class="mb-4">
            <h4>用户信息</h4>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="phone" class="form-label">手机号码</label>
                    <input type="tel" class="form-control" id="phone" placeholder="请输入手机号码">
                </div>
                <div class="col-md-6">
                    <label for="password" class="form-label">密码</label>
                    <input type="password" class="form-control" id="password" placeholder="请设置密码">
                </div>
            </div>
        </div>
        
        <!-- 添加配置区域标题 -->
        <div class="mb-3">
            <h4>伴侣微信配置</h4>
        </div>
        
        <!-- 配置区域 -->
        <div class="config-section" id="configSection">
            <form id="configForm">
                <!-- 用户ID (登录后自动填充或隐藏) -->
                <input type="hidden" id="user_id" name="user_id">

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="app_id" class="form-label required">微信公众号AppID</label>
                        <input type="text" class="form-control" id="app_id" name="app_id" required>
                    </div>
                    <div class="col-md-6">
                        <label for="app_secret" class="form-label required">微信公众号AppSecret</label>
                        <input type="password" class="form-control" id="app_secret" name="app_secret" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="partner_openid" class="form-label required">伴侣的OpenID</label>
                        <input type="text" class="form-control" id="partner_openid" name="user_openid" required>
                    </div>
                    <div class="col-md-6">
                        <label for="template_id" class="form-label required">早安模板ID</label>
                        <input type="text" class="form-control" id="template_id" name="template_id" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="indices_template_id" class="form-label">天气指数模板ID (可选)</label>
                        <input type="text" class="form-control" id="indices_template_id" name="indices_template_id">
                    </div>
                    <div class="col-md-6">
                        <label for="location_name" class="form-label required">天气查询-区县名</label>
                        <input type="text" class="form-control" id="location_name" name="location_name" required placeholder="例如: 朝阳区">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="adm_name" class="form-label required">天气查询-市/省名</label>
                        <input type="text" class="form-control" id="adm_name" name="adm_name" required placeholder="例如: 北京市 或 河北省">
                    </div>
                    <div class="col-md-6">
                        <label for="meet_date" class="form-label">相爱纪念日 (可选)</label>
                        <input type="date" class="form-control" id="meet_date" name="meet_date">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="partner_birthday" class="form-label">你的生日 (可选)</label>
                        <input type="date" class="form-control" id="partner_birthday" name="partner_birthday">
                    </div>
                    <div class="col-md-6">
                        <label for="xiazhou_birthday" class="form-label">Ta的生日 (可选)</label>
                        <input type="date" class="form-control" id="xiazhou_birthday" name="xiazhou_birthday">
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button id="testButton" type="button" class="btn btn-info me-md-2">
                        <i class="bi bi-send"></i> 测试发送
                    </button>
                </div>
            </form>
            
            <hr class="my-4">
            
            <!-- 用户本人配置区域 -->
            <div id="userConfigSection" class="mt-4">
                <h4>您的个人微信配置</h4>
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> 如果您希望自己也收到每日问候，请填写以下信息并选择<strong>双人套餐</strong>
                </div>
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label for="self_openid" class="form-label">您的微信OpenID</label>
                        <input type="text" class="form-control" id="self_openid" placeholder="请输入您的微信OpenID">
                    </div>
                    <div class="col-md-6">
                        <label for="user_location_name" class="form-label">您所在的区县</label>
                        <input type="text" class="form-control" id="user_location_name" placeholder="例如：海淀区">
                    </div>
                    <div class="col-md-6">
                        <label for="user_adm_name" class="form-label">您所在的城市</label>
                        <input type="text" class="form-control" id="user_adm_name" placeholder="例如：北京市">
                    </div>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button id="testSelfButton" type="button" class="btn btn-info">
                        <i class="bi bi-send"></i> 测试发送给您自己
                    </button>
                </div>
            </div>
            
            <!-- 将所有区域的保存按钮放在最下方 -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button id="saveButton" type="button" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle"></i> 保存配置
                </button>
            </div>
        </div>
        
        <!-- 加载中提示 -->
        <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">处理中，请稍候...</p>
        </div>
    </div>
    
    <!-- 修改支付模态框，添加套餐选择 -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">选择订阅套餐</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 套餐选择部分 -->
                    <div id="planSelection">
                        <p class="mb-3">请选择您喜欢的订阅套餐:</p>
                        
                        <div class="plan-option mb-3 p-3 border rounded" data-plan="monthly">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="modal-plan" id="modalPlanMonthly" value="monthly" checked>
                                <label class="form-check-label" for="modalPlanMonthly">
                                    <h5 class="mb-1">月付套餐</h5>
                                    <p class="mb-1">月付 <span id="modalPriceMonthly" class="fw-bold">24.9</span> 元</p>
                                    <p class="mb-0 text-muted">每天自动发送早安问候给伴侣</p>
                                    <p class="mb-0 text-secondary small"><i class="bi bi-info-circle"></i> 仅保存伴侣配置，不包含发送给您自己</p>
                                </label>
                            </div>
                        </div>
                        
                        <div class="plan-option mb-3 p-3 border rounded" data-plan="annual">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="modal-plan" id="modalPlanAnnual" value="annual">
                                <label class="form-check-label" for="modalPlanAnnual">
                                    <h5 class="mb-1">年付套餐</h5>
                                    <p class="mb-1">每年 <span id="modalPriceAnnual" class="fw-bold">2</span> 元</p>
                                    <p class="mb-0 text-muted small">每天自动发送早安问候给伴侣（相当于免费用 <span id="modalDiscountMonthly">1</span> 个月）</p>
                                </label>
                            </div>
                        </div>

                        <div class="plan-option mb-3 p-3 border rounded" data-plan="dual">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="modal-plan" id="modalPlanDual" value="dual">
                                <label class="form-check-label" for="modalPlanDual">
                                    <h5 class="mb-1">双人年付套餐 <span class="badge bg-primary">推荐</span></h5>
                                    <p class="mb-1">年付 <span id="modalPriceDual" class="fw-bold">52</span> 元</p>
                                    <p class="mb-0 text-muted">每天<strong>同时</strong>自动发送早安问候给您和伴侣</p>
                                    <p class="mb-0 text-success small"><i class="bi bi-check-circle-fill"></i> 包含保存您个人配置的功能</p>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 双人套餐配置区域，仅在选择双人套餐时显示 -->
                    <div id="modalUserConfigSection" class="mt-4" style="display: none;">
                        <h5>您的个人微信配置</h5>
                        <div class="mb-3">
                            <label for="modal_self_openid" class="form-label">您的微信OpenID</label>
                            <input type="text" class="form-control" id="modal_self_openid" placeholder="请输入您的微信OpenID">
                        </div>
                        <div class="mb-3">
                            <label for="modal_user_location_name" class="form-label">您所在的区县</label>
                            <input type="text" class="form-control" id="modal_user_location_name" placeholder="例如：海淀区">
                        </div>
                        <div class="mb-3">
                            <label for="modal_user_adm_name" class="form-label">您所在的城市</label>
                            <input type="text" class="form-control" id="modal_user_adm_name" placeholder="例如：北京市">
                        </div>
                    </div>
                    
                    <!-- 支付加载中状态 -->
                    <div id="paymentLoading" style="display:none;">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-3">正在创建支付订单，请稍候...</p>
                        </div>
                </div>
                
                    <!-- 支付二维码显示 -->
                    <div id="qrCodeContainer" style="display:none;" class="text-center py-3">
                        <h5 class="mb-3">请使用支付宝或微信扫码完成支付</h5>
                        <img id="qrCodeImage" src="" alt="支付二维码" class="img-fluid mb-3" style="max-width: 200px;">
                        <p class="text-muted small">扫码后请在手机上完成支付</p>
                        <div class="alert alert-info small">
                            <i class="bi bi-info-circle"></i> 支付完成后，请点击下方"我已完成支付"按钮
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <div>
                        <button id="confirmPaymentButton" type="button" class="btn btn-primary">确认订阅</button>
                        <button id="paymentCompleteButton" type="button" class="btn btn-success" style="display:none;">我已完成支付</button>
                    </div>
                </div>
        </div>
        </div>
    </div>
    
    <!-- 修改页脚联系信息 -->
    <footer class="mt-5 text-center text-muted">
        <p>微信公众号：简的小屋子，发送你的问题，我们将为您提供服务。</p>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 使用实际的云函数URL
        const API_BASE_URL = 'https://1337331310-2gg2yrldrk.ap-beijing.tencentscf.com'; // 微信配置云函数 
        const MORNING_GREETING_URL = 'https://1337331310-kko6t1lktu.ap-beijing.tencentscf.com'; // 早安问候云函数
        
        // DOM元素
        const configForm = document.getElementById('configForm');
        const saveButton = document.getElementById('saveButton');
        const testButton = document.getElementById('testButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const configSection = document.getElementById('configSection');
        const confirmPaymentButton = document.getElementById('confirmPaymentButton');
        const paymentCompleteButton = document.getElementById('paymentCompleteButton');
        
        // 支付相关
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 从API获取价格信息
            fetchPriceInfo();
            
            // 显示配置部分
            configSection.style.display = 'block';
            
            // 测试发送给伴侣按钮点击事件
            testButton.addEventListener('click', function() {
                const config = collectConfigData();
                if (validateConfig(config)) {
                    sendTestMessage(config, false);
                }
            });
            
            // 测试发送给自己按钮点击事件
            document.getElementById('testSelfButton').addEventListener('click', function() {
                const partnerConfig = collectConfigData();
                const userConfig = collectUserConfigData(partnerConfig);
                
                if (validateUserConfig(userConfig)) {
                    sendTestMessage(userConfig, true);
                }
            });
            
            // 保存配置按钮点击事件
            saveButton.addEventListener('click', function() {
                // 获取用户信息和配置
                const phone = document.getElementById('phone').value;
                const password = document.getElementById('password').value;
                const config = collectConfigData();
                
                if (!phone || !password) {
                    alert('请填写手机号和密码');
                    return;
                }
                
                if (!validateConfig(config)) {
                    return;
                }
                
                // 保存用户本人配置以备后用
                const userConfig = collectUserConfigData(config);
                
                // 保存临时信息
                sessionStorage.setItem('pendingPhone', phone);
                sessionStorage.setItem('pendingPassword', password);
                sessionStorage.setItem('pendingConfig', JSON.stringify(config));
                sessionStorage.setItem('pendingUserConfig', JSON.stringify(userConfig));
                
                // 显示套餐选择模态框
                showPaymentModal(phone, password, config);
            });
            
            // 确认订阅按钮点击事件
            confirmPaymentButton.addEventListener('click', function() {
                // 获取选中的套餐
                const selectedPlan = document.querySelector('input[name="modal-plan"]:checked').value;
                
                // 如果是双人套餐，检查用户配置
                if (selectedPlan === 'dual') {
                    const selfOpenid = document.getElementById('modal_self_openid').value;
                    const userLocationName = document.getElementById('modal_user_location_name').value;
                    const userAdmName = document.getElementById('modal_user_adm_name').value;
                    
                    if (!selfOpenid || !userLocationName || !userAdmName) {
                        alert('请填写您的个人配置信息');
                        return;
                    }
                    
                    // 保存个人配置到sessionStorage
                    sessionStorage.setItem('self_openid', selfOpenid);
                    sessionStorage.setItem('user_location_name', userLocationName);
                    sessionStorage.setItem('user_adm_name', userAdmName);
                }
                
                // 从模态框中获取信息
                const phone = sessionStorage.getItem('temp_phone');
                const password = sessionStorage.getItem('temp_password');
                const config = JSON.parse(sessionStorage.getItem('temp_config') || '{}');
                
                // 创建订单并处理支付
                processPurchase(phone, password, config, selectedPlan);
            });
            
            // "我已完成支付"按钮点击事件
            paymentCompleteButton.addEventListener('click', function() {
                // 检查订单状态
                const orderId = sessionStorage.getItem('currentOrderId');
                if (orderId) {
                    checkOrderStatus(orderId);
                }
            });
            
            // 双人套餐选择事件
            document.querySelectorAll('input[name="modal-plan"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const dualConfigSection = document.getElementById('modalUserConfigSection');
                    if (this.value === 'dual') {
                        dualConfigSection.style.display = 'block';
                    } else {
                        dualConfigSection.style.display = 'none';
                    }
                });
            });
            
            // 检查URL参数中是否有支付成功标记
            const urlParams = new URLSearchParams(window.location.search);
            const paymentResult = urlParams.get('payment_result');
            
            if (paymentResult === 'success') {
                paymentSuccess();
                
                // 移除URL参数
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
        
        // 从API获取价格信息
        function fetchPriceInfo() {
            console.log('正在获取价格信息，API地址:', `${API_BASE_URL}/api/price`);
            
            fetch(`${API_BASE_URL}/api/price`)
                .then(response => {
                    console.log('价格API响应状态:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP错误! 状态: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('获取到的价格数据:', data);
                    // 更新模态框中的价格显示
                    document.getElementById('modalPriceMonthly').textContent = data.monthly;
                    document.getElementById('modalPriceAnnual').textContent = data.annual;
                    document.getElementById('modalPriceDual').textContent = data.dual;
                    
                    // 计算月付年付的差价
                    const monthlyPrice = parseFloat(data.monthly);
                    const annualPrice = parseFloat(data.annual);
                    const savingMonths = Math.round((monthlyPrice * 12 - annualPrice) / monthlyPrice);
                    
                    document.getElementById('modalDiscountMonthly').textContent = savingMonths;
                })
                .catch(error => {
                    console.error('获取价格信息失败，使用环境变量默认价格:', error);
                    // 使用环境变量中的默认价格
                    const defaultPrices = {
                        monthly: 24.9,
                        annual: 29.9,
                        dual: 52
                    };
                    // 更新模态框中的价格显示
                    document.getElementById('modalPriceMonthly').textContent = defaultPrices.monthly;
                    document.getElementById('modalPriceAnnual').textContent = defaultPrices.annual;
                    document.getElementById('modalPriceDual').textContent = defaultPrices.dual;
                    
                    // 计算月付年付的差价
                    const savingMonths = Math.round((defaultPrices.monthly * 12 - defaultPrices.annual) / defaultPrices.monthly);
                    document.getElementById('modalDiscountMonthly').textContent = savingMonths;
                });
        }
        
        // 显示支付模态框
        function showPaymentModal(phone, password, config) {
            // 保存临时数据到sessionStorage
            sessionStorage.setItem('temp_phone', phone);
            sessionStorage.setItem('temp_password', password);
            sessionStorage.setItem('temp_config', JSON.stringify(config));
            
            // 隐藏其他组件，显示套餐选择
            document.getElementById('planSelection').style.display = 'block';
            document.getElementById('paymentLoading').style.display = 'none';
            document.getElementById('qrCodeContainer').style.display = 'none';
            confirmPaymentButton.style.display = 'inline-block';
            paymentCompleteButton.style.display = 'none';
            
            // 显示模态框
            paymentModal.show();
        }
        
        // 处理购买流程
        function processPurchase(phone, password, config, plan) {
            // 获取当前显示的价格
            let price;
            if (plan === 'monthly') {
                price = document.getElementById('modalPriceMonthly').textContent;
            } else if (plan === 'annual') {
                price = document.getElementById('modalPriceAnnual').textContent;
            } else if (plan === 'dual') {
                price = document.getElementById('modalPriceDual').textContent;
            }
            
            console.log(`创建订单: 套餐=${plan}, 价格=${price}`);
            
            // 隐藏套餐选择，显示加载中
            document.getElementById('planSelection').style.display = 'none';
            document.getElementById('modalUserConfigSection').style.display = 'none';
            document.getElementById('paymentLoading').style.display = 'block';
            confirmPaymentButton.style.display = 'none';
            
            // 创建订单
            fetch(`${API_BASE_URL}/api/payment/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    phone: phone,
                    password: password,
                    plan: plan,
                    config: config
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('paymentLoading').style.display = 'none';
                
                if (data.success) {
                    // 保存订单信息
                    sessionStorage.setItem('currentOrderId', data.order_id);
                    sessionStorage.setItem('pendingConfig', JSON.stringify(config));
                    sessionStorage.setItem('pendingPhone', phone);
                    sessionStorage.setItem('pendingPassword', password);
                    sessionStorage.setItem('pendingPlan', plan);
                    
                    // 处理支付信息
                    if (data.payment_info.payment_type === 'qrcode') {
                        // 显示二维码
                        document.getElementById('qrCodeImage').src = data.payment_info.qr_code_url;
                        document.getElementById('qrCodeContainer').style.display = 'block';
                        paymentCompleteButton.style.display = 'inline-block';
                    } else if (data.payment_info.payment_type === 'form_redirect') {
                        // 创建并提交表单
                        const formContainer = document.createElement('div');
                        formContainer.innerHTML = data.payment_info.redirect_form;
                        document.body.appendChild(formContainer);
                        
                        // 关闭模态框
                        paymentModal.hide();
                        
                        // 自动提交表单
                        const form = formContainer.querySelector('form');
                        if (form) {
                            form.submit();
                        }
                    } else if (data.payment_info.payment_type === 'redirect') {
                        // 跳转到支付页面
                        window.location.href = data.payment_info.redirect_url;
                    }
                } else {
                    alert(data.message || '创建订单失败');
                    
                    // 重新显示套餐选择
                    document.getElementById('planSelection').style.display = 'block';
                    confirmPaymentButton.style.display = 'inline-block';
                }
            })
            .catch(error => {
                console.error('创建订单失败:', error);
                alert('创建订单失败，请稍后再试');
                
                document.getElementById('paymentLoading').style.display = 'none';
                document.getElementById('planSelection').style.display = 'block';
                confirmPaymentButton.style.display = 'inline-block';
            });
        }
        
        // 检查订单状态
        function checkOrderStatus(orderId) {
            fetch(`${API_BASE_URL}/api/payment/check-status?order_id=${orderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.paid) {
                        // 订单已支付
                        paymentSuccess();
                        paymentModal.hide();
                    } else {
                        alert('订单尚未支付完成，请完成支付后再试');
                    }
                })
                .catch(error => {
                    console.error('检查订单状态失败:', error);
                    alert('检查订单状态失败，请稍后再试');
                });
        }
        
        // 支付成功处理
        function paymentSuccess() {
            // 获取缓存的信息
            const plan = sessionStorage.getItem('pendingPlan');
            const phone = sessionStorage.getItem('pendingPhone');
            const password = sessionStorage.getItem('pendingPassword');
            const config = JSON.parse(sessionStorage.getItem('pendingConfig') || '{}');
            
            // 保存伴侣配置
            saveUserConfig(phone, password, config, plan, false);
            
            // 只有在选择了双人套餐时，才保存用户本人的配置
            if (plan === 'dual') {
                const userConfig = JSON.parse(sessionStorage.getItem('pendingUserConfig') || '{}');
                
                // 验证用户本人的配置是否完整
                if (userConfig.user_openid && userConfig.location_name && userConfig.adm_name) {
                    // 使用user_id + "_1"作为用户本人配置的标识
                    saveUserConfig(phone + "_1", password, userConfig, plan, true);
                    console.log('双人套餐 - 用户本人配置已保存');
                } else {
                    console.warn('双人套餐 - 用户本人配置不完整，跳过保存');
                    alert('注意：您选择了双人套餐，但您的个人配置信息不完整，仅保存了伴侣配置。');
                }
            } else {
                console.log('非双人套餐 - 仅保存伴侣配置');
            }
            
            // 显示成功消息
            alert('支付成功！您的配置已保存。' + 
                  (plan === 'dual' ? '\n您和伴侣将每天收到问候。' : '\n伴侣将每天收到问候。'));
            
            // 清除缓存的信息
            clearSessionStorage();
        }
        
        // 清除会话存储
        function clearSessionStorage() {
            sessionStorage.removeItem('pendingConfig');
            sessionStorage.removeItem('pendingUserConfig');
            sessionStorage.removeItem('pendingPhone');
            sessionStorage.removeItem('pendingPassword');
            sessionStorage.removeItem('pendingPlan');
            sessionStorage.removeItem('currentOrderId');
        }
        
        // 收集配置信息
        function collectConfigData() {
            return {
                app_id: document.getElementById('app_id').value,
                app_secret: document.getElementById('app_secret').value,
                user_openid: document.getElementById('partner_openid').value,
                template_id: document.getElementById('template_id').value,
                indices_template_id: document.getElementById('indices_template_id').value,
                location_name: document.getElementById('location_name').value,
                adm_name: document.getElementById('adm_name').value,
                meet_date: document.getElementById('meet_date').value,
                partner_birthday: document.getElementById('partner_birthday').value,
                xiazhou_birthday: document.getElementById('xiazhou_birthday').value
            };
        }
        
        // 验证配置信息
        function validateConfig(config) {
            const requiredFields = ['app_id', 'app_secret', 'user_openid', 'template_id', 'location_name', 'adm_name'];
            const missingFields = requiredFields.filter(field => !config[field]);
            
            if (missingFields.length > 0) {
                alert(`请填写必要的配置信息: ${missingFields.join(', ')}`);
                return false;
            }
            
            return true;
        }
        
        // 发送测试消息
        function sendTestMessage(config, isUser) {
            loadingSpinner.style.display = 'block';
            
            console.log(`准备发送测试消息给${isUser ? '您自己' : '伴侣'}:`, config);
            
            // 调用morning_greeting云函数发送测试消息
            fetch(`${MORNING_GREETING_URL}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const recipient = isUser ? '您' : '伴侣';
                    alert(`发送给${recipient}的测试消息成功！`);
                } else {
                    const recipient = isUser ? '您' : '伴侣';
                    alert(`发送给${recipient}的测试消息失败: ${data.message}`);
                }
                loadingSpinner.style.display = 'none';
            })
            .catch(error => {
                console.error('发送测试消息失败:', error);
                const recipient = isUser ? '您' : '伴侣';
                alert(`发送给${recipient}的测试消息失败，请检查配置信息`);
                loadingSpinner.style.display = 'none';
            });
        }
        
        // 保存用户配置
        function saveUserConfig(phone, password, config, plan, isUserConfig) {
            console.log(`保存${isUserConfig ? '用户本人' : '伴侣'}配置到后端:`, {
                phone,
                plan,
                is_user_config: isUserConfig
            });
            
            fetch(`${API_BASE_URL}/api/payment/complete-setup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    phone: phone,
                    password: password,
                    config: config,
                    plan: plan,
                    order_id: sessionStorage.getItem('currentOrderId'),
                    is_user_config: isUserConfig
                })
            })
            .then(response => response.json())
            .then(result => {
                console.log(`${isUserConfig ? '用户本人' : '伴侣'}配置保存结果:`, result);
            })
            .catch(error => {
                console.error(`保存${isUserConfig ? '用户本人' : '伴侣'}配置失败:`, error);
            });
        }
        
        // 收集用户本人的配置信息
        function collectUserConfigData(partnerConfig) {
            // 克隆伴侣配置作为基础
            const userConfig = {...partnerConfig};
            
            // 更新用户特定的配置
            userConfig.user_openid = document.getElementById('self_openid').value;
            userConfig.location_name = document.getElementById('user_location_name').value;
            userConfig.adm_name = document.getElementById('user_adm_name').value;
            
            // 交换生日信息
            [userConfig.partner_birthday, userConfig.xiazhou_birthday] = 
                [userConfig.xiazhou_birthday, userConfig.partner_birthday];
            
            return userConfig;
        }
        
        // 验证用户本人的配置信息
        function validateUserConfig(config) {
            if (!config.user_openid) {
                alert('请填写您的微信OpenID');
                return false;
            }
            
            if (!config.location_name) {
                alert('请填写您所在的区县');
                return false;
            }
            
            if (!config.adm_name) {
                alert('请填写您所在的城市');
                return false;
            }
            
            return true;
        }

        // 完成前端创建订单函数的修改
        function createOrder(phone, plan) {
            // 获取当前显示的价格
            let price;
            if (plan === 'monthly') {
                price = document.getElementById('modalPriceMonthly').textContent;
            } else if (plan === 'annual') {
                price = document.getElementById('modalPriceAnnual').textContent;
            } else if (plan === 'dual') {
                price = document.getElementById('modalPriceDual').textContent;
            }
            
            console.log(`创建订单: 套餐=${plan}, 显示价格=${price}`);
            
            // 生成订单并存储信息
            sessionStorage.setItem('pendingPlan', plan);
            
            // 调用API创建订单
            fetch(`${API_BASE_URL}/api/payment/create-order`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    phone: phone,
                    plan: plan
                    // 注意：不传递价格参数，让后端根据plan决定正确的价格
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('订单创建成功，支付页面URL:', data.payment_url);
                    console.log('订单ID:', data.order_id);
                    
                    // 存储订单ID
                    sessionStorage.setItem('currentOrderId', data.order_id);
                    
                    // 显示支付二维码
                    document.getElementById('paymentQrcode').src = data.qrcode_url || 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(data.payment_url);
                    document.getElementById('planSelection').style.display = 'none';
                    document.getElementById('qrcodeSection').style.display = 'block';
                    
                    // 提供支付链接
                    const paymentLink = document.getElementById('paymentLink');
                    paymentLink.href = data.payment_url;
                    paymentLink.style.display = 'block';
                    
                    // 检查支付状态
                    checkPaymentStatus(data.order_id);
                } else {
                    alert('创建订单失败: ' + data.message);
                    console.error('创建订单失败:', data);
                }
            })
            .catch(error => {
                alert('创建订单发生错误，请稍后再试');
                console.error('创建订单错误:', error);
            });
        }
    </script>
    
    <!-- 51LA统计代码 - 放在body结束标签前 -->
    <script type="text/javascript" src="//js.users.51.la/21954557.js"></script>
</body>
</html> 
