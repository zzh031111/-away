<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信早安推送配置</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .container { max-width: 700px; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .form-label { font-weight: bold; }
        .alert { margin-top: 20px; }
        .required::after { content: '*'; color: red; margin-left: 2px; }
        /* 新增样式 */
        .auth-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .config-section { display: none; /* 默认隐藏配置区域 */ }
        .user-status { margin-bottom: 15px; font-style: italic; }
        .tutorial-link { margin-bottom: 20px; padding: 10px; background-color: #e9f5ff; border: 1px solid #b3d7ff; border-radius: 5px; }
        .payment-modal-body { /* 支付模态框样式 */ }
        .plan-option { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; }
        .plan-option.selected { border-color: #0d6efd; background-color: #e7f1ff; }
        .plan-option h5 { margin-top: 0; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center mb-4">微信早安晚安推送配置</h2>

        <!-- 使用前必看教程 -->
        <div class="tutorial-link">
            <strong>重要提示：</strong> 使用前请务必查看 <a href="https://bcn1jsdnj3t6.feishu.cn/wiki/DRsNwylmAiJxVokNmfnczd5XnMa?from=from_copylink" target="_blank" rel="noopener noreferrer">详细使用教程</a>，了解各项配置含义及获取方法！
        </div>
        
        <!-- 认证区域 -->
        <div class="auth-section">
            <h4>用户登录/注册</h4>
            <div class="user-status" id="userStatus">状态：未登录</div>
            <form id="authForm">
                <div class="mb-3">
                    <label for="phone" class="form-label required">手机号</label>
                    <input type="tel" class="form-control" id="phone" name="phone" required pattern="^1[3-9]\d{9}$" title="请输入有效的11位手机号">
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label required">密码</label>
                    <input type="password" class="form-control" id="password" name="password" required minlength="6">
                </div>
                <button type="button" class="btn btn-primary me-2" id="loginButton">登录</button>
                <button type="button" class="btn btn-success" id="registerButton">注册并配置</button>
                <button type="button" class="btn btn-secondary" id="logoutButton" style="display: none;">退出登录</button>
            </form>
            <div id="authMessage" class="alert mt-3" style="display: none;"></div>
        </div>
        
        <!-- 配置区域 -->
        <div class="config-section" id="configSection">
            <h4>详细配置信息</h4>
            <form id="configForm">
                <!-- 用户ID (登录后自动填充或隐藏) -->
                <input type="hidden" id="user_id" name="user_id">

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="app_id" class="form-label required">微信公众号AppID</label>
                        <input type="text" class="form-control" id="app_id" name="app_id" required>
                    </div>
                    <div class="col-md-6">
                        <label for="app_secret" class="form-label required">微信公众号AppSecret</label>
                        <input type="password" class="form-control" id="app_secret" name="app_secret" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="user_openid" class="form-label required">接收消息用户的OpenID</label>
                        <input type="text" class="form-control" id="user_openid" name="user_openid" required>
                    </div>
                    <div class="col-md-6">
                        <label for="template_id" class="form-label required">早安模板ID</label>
                        <input type="text" class="form-control" id="template_id" name="template_id" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="indices_template_id" class="form-label">晚安模板ID (可选)</label>
                        <input type="text" class="form-control" id="indices_template_id" name="indices_template_id">
                    </div>
                    <div class="col-md-6">
                        <label for="location_name" class="form-label required">天气查询-区县名</label>
                        <input type="text" class="form-control" id="location_name" name="location_name" required placeholder="例如: 朝阳区">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="adm_name" class="form-label required">天气查询-市/省名</label>
                        <input type="text" class="form-control" id="adm_name" name="adm_name" required placeholder="例如: 北京市 或 河北省">
                    </div>
                    <div class="col-md-6">
                        <label for="meet_date" class="form-label">相识纪念日 (可选)</label>
                        <input type="date" class="form-control" id="meet_date" name="meet_date">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="partner_birthday" class="form-label">你的生日 (可选)</label>
                        <input type="date" class="form-control" id="partner_birthday" name="partner_birthday">
                    </div>
                    <div class="col-md-6">
                        <label for="xiazhou_birthday" class="form-label">Ta的生日 (可选)</label>
                        <input type="date" class="form-control" id="xiazhou_birthday" name="xiazhou_birthday">
                    </div>
                </div>
                
                <div class="d-flex justify-content-end mt-4">
                    <button type="button" class="btn btn-info me-2" id="testSendButton">测试发送</button>
                    <button type="button" class="btn btn-primary" id="saveConfigButton">保存配置</button>
                </div>
            </form>
            <div id="loadingMessage" class="alert alert-info" style="display: none;"></div>
            <div id="successMessage" class="alert alert-success" style="display: none;"></div>
            <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
        </div>
    </div>
    
    <!-- 支付模态框 -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="paymentModalLabel">选择订阅计划</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body payment-modal-body">
            <p>首次保存配置或订阅到期后，需要选择一个订阅计划以继续使用服务。</p>
            <div class="plan-option" data-plan="monthly">
              <h5>月度会员</h5>
              <p>价格：24.9元/月</p>
            </div>
            <div class="plan-option" data-plan="annual">
              <h5>年度会员</h5>
              <p>价格：29.9元/年 (推荐)</p>
            </div>
            <div id="paymentInfo" class="mt-3" style="display: none;">
                <!-- 这里将显示支付二维码或跳转按钮 -->
                <p>请使用微信/支付宝扫描下方二维码完成支付：</p>
                <div id="qrcode"></div>
                <p id="paymentStatus">等待支付结果...</p>
            </div>
            <div id="paymentError" class="alert alert-danger mt-3" style="display: none;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            <button type="button" class="btn btn-primary" id="confirmPaymentButton" disabled>确认支付</button>
          </div>
        </div>
      </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script> <!-- 用于生成二维码 -->
    <script>
        const authForm = document.getElementById('authForm');
        const configForm = document.getElementById('configForm');
        const loginButton = document.getElementById('loginButton');
        const registerButton = document.getElementById('registerButton');
        const logoutButton = document.getElementById('logoutButton');
        const saveConfigButton = document.getElementById('saveConfigButton');
        const testSendButton = document.getElementById('testSendButton');
        const authMessage = document.getElementById('authMessage');
        const loadingMessage = document.getElementById('loadingMessage');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const configSection = document.getElementById('configSection');
        const userStatus = document.getElementById('userStatus');
        const paymentModalElement = document.getElementById('paymentModal');
        const paymentModal = new bootstrap.Modal(paymentModalElement);
        const paymentInfo = document.getElementById('paymentInfo');
        const qrcodeContainer = document.getElementById('qrcode');
        const paymentStatus = document.getElementById('paymentStatus');
        const paymentError = document.getElementById('paymentError');
        const confirmPaymentButton = document.getElementById('confirmPaymentButton');

        // API 端点 (根据您的实际部署修改)
        const API_BASE_URL = 'https://1337331310-2gg2yrldrk.ap-beijing.tencentscf.com'; // wx_config_api 的 URL
        const MORNING_GREETING_URL = 'https://1337331310-kko6t1lktu.ap-beijing.tencentscf.com'; // morning_greeting 的 URL

        let currentPlan = null; // 当前选择的支付计划
        let currentOrderId = null; // 当前支付订单号
        let paymentPollInterval = null; // 支付状态轮询定时器
        let authToken = localStorage.getItem('authToken'); // 从本地存储读取Token
        let loggedInUser = localStorage.getItem('loggedInUser'); // 登录的手机号

        // --- 辅助函数 ---
        function showMessage(element, message, isSuccess) {
            element.textContent = message;
            element.className = `alert ${isSuccess ? 'alert-success' : 'alert-danger'}`;
            element.style.display = 'block';
        }

        function clearMessages() {
            authMessage.style.display = 'none';
            loadingMessage.style.display = 'none';
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';
            paymentError.style.display = 'none';
        }

        function setConfigFormDisabled(disabled) {
            Array.from(configForm.elements).forEach(el => el.disabled = disabled);
            testSendButton.disabled = disabled;
            saveConfigButton.disabled = disabled;
        }

        function setAuthFormDisabled(disabled) {
             Array.from(authForm.elements).forEach(el => el.disabled = disabled);
             loginButton.disabled = disabled;
             registerButton.disabled = disabled;
        }

        function updateLoginStatus() {
            if (authToken && loggedInUser) {
                userStatus.textContent = `状态：已登录 (${loggedInUser})`;
                loginButton.style.display = 'none';
                registerButton.style.display = 'none';
                logoutButton.style.display = 'inline-block';
                configSection.style.display = 'block';
                // 登录后自动加载配置
                loadUserConfig();
            } else {
                userStatus.textContent = '状态：未登录';
                loginButton.style.display = 'inline-block';
                registerButton.style.display = 'inline-block';
                logoutButton.style.display = 'none';
                configSection.style.display = 'none';
                configForm.reset(); // 清空表单
            }
        }

        function getFormData(form) {
            const formData = {};
            // 记录在收集过程中的任何问题
            let missingFields = [];
            
            // 获取所有输入字段
            const inputs = form.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                if (input.name) {
                    formData[input.name] = input.value;
                    // 检查必填字段是否填写
                    if (input.required && !input.value) {
                        missingFields.push(input.name);
                    }
                }
            });
            
            // 记录收集结果
            console.log('表单数据收集结果:', formData);
            if (missingFields.length > 0) {
                console.warn('缺少必填字段:', missingFields);
            }
            
            return formData;
        }

        // --- API 调用 ---
        async function apiCall(endpoint, method = 'GET', data = null, requiresAuth = false) {
            const url = `${API_BASE_URL}${endpoint}`;
            const headers = { 'Content-Type': 'application/json' };
            if (requiresAuth && authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            const options = {
                method: method,
                headers: headers,
            };
            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(url, options);
                if (response.status === 401) { // Token失效或未授权
                    logout();
                    showMessage(authMessage, '登录已过期或无效，请重新登录。', false);
                    throw new Error('Unauthorized');
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: `HTTP error! status: ${response.status}` }));
                    throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                }
                // 处理 204 No Content
                 if (response.status === 204) {
                    return { success: true, message: '操作成功完成。' }; // 或者返回 null/undefined
                }
                return await response.json();
            } catch (error) {
                console.error('API Call Error:', error);
                throw error; // 将错误继续抛出，以便调用者处理
            }
        }

        // --- 事件处理 ---
        loginButton.addEventListener('click', async () => {
            clearMessages();
            const phoneInput = document.getElementById('phone');
            const passwordInput = document.getElementById('password');

            if (!phoneInput.checkValidity() || !passwordInput.checkValidity()) {
                 showMessage(authMessage, '请输入有效的手机号和密码（至少6位）。', false);
                 authForm.reportValidity(); // 触发浏览器默认验证提示
                 return;
            }

            setAuthFormDisabled(true);
            try {
                const data = getFormData(authForm);
                const result = await apiCall('/api/login', 'POST', data);
                if (result.success && result.token) {
                    authToken = result.token;
                    loggedInUser = data.phone;
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('loggedInUser', loggedInUser);
                    showMessage(authMessage, '登录成功！正在加载配置...', true);
                    updateLoginStatus();
                } else {
                    showMessage(authMessage, result.message || '登录失败，请检查手机号或密码。', false);
                }
            } catch (error) {
                showMessage(authMessage, `登录时出错: ${error.message}`, false);
            } finally {
                setAuthFormDisabled(false);
            }
        });

        registerButton.addEventListener('click', () => {
            clearMessages();
            const phoneInput = document.getElementById('phone');
            const passwordInput = document.getElementById('password');

            if (!phoneInput.checkValidity() || !passwordInput.checkValidity()) {
                 showMessage(authMessage, '请输入有效的手机号和密码（至少6位）以进行注册。', false);
                 authForm.reportValidity();
                 return;
            }
            // 允许进入配置阶段，保存时再处理注册逻辑
            loggedInUser = phoneInput.value; // 暂存手机号
            authToken = null; // 清除可能存在的旧token
            localStorage.removeItem('authToken');
            localStorage.removeItem('loggedInUser');
            userStatus.textContent = `状态：准备注册 (${loggedInUser})`;
            configSection.style.display = 'block';
            configForm.reset(); // 清空可能存在的旧配置
            showMessage(authMessage, '请填写下面的配置信息，点击"保存配置"时将完成注册和支付。', true);
            loginButton.style.display = 'none';
            registerButton.style.display = 'none';
            logoutButton.style.display = 'none'; // 注册过程中不显示退出
        });

        logoutButton.addEventListener('click', () => {
            logout();
            showMessage(authMessage, '已退出登录。', true);
        });

        function logout() {
            authToken = null;
            loggedInUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('loggedInUser');
            updateLoginStatus();
        }

        // 加载用户配置
        async function loadUserConfig() {
            if (!authToken) return;
            setConfigFormDisabled(true);
            try {
                const result = await apiCall('/api/config/get', 'GET', null, true);
                if (result.success && result.config) {
                    // 填充表单
                    for (const key in result.config) {
                        if (configForm.elements[key]) {
                            configForm.elements[key].value = result.config[key];
                        }
                    }
                    // 可以在这里显示用户的订阅状态 result.subscription_status
                    showMessage(successMessage, '配置加载成功。', true);
                } else {
                    showMessage(errorMessage, result.message || '加载配置失败。', false);
                     // 如果是新用户或配置丢失，不清空表单，允许用户填写
                }
            } catch (error) {
                 showMessage(errorMessage, `加载配置时出错: ${error.message}`, false);
                 // 出错时不清空表单，允许用户填写
            } finally {
                 setConfigFormDisabled(false);
            }
        }

        // 测试发送
        testSendButton.addEventListener('click', async () => {
            clearMessages();
            if (!configForm.checkValidity()) {
                showMessage(errorMessage, '请填写所有必填项后再发送测试。', false);
                configForm.reportValidity();
                return;
            }

            setConfigFormDisabled(true);
            loadingMessage.textContent = '正在发送测试消息...';
            loadingMessage.style.display = 'block';

            // 收集表单数据
            const configData = getFormData(configForm);
            
            // 添加调试日志，检查要发送的数据
            console.log('准备发送到morning_greeting的数据:', JSON.stringify(configData, null, 2));

            // 确认必填字段
            if (!configData.user_openid || !configData.location_name || !configData.adm_name) {
                errorMessage.textContent = '错误: 请确保填写了微信用户ID、区县名和市/省名';
                errorMessage.style.display = 'block';
                loadingMessage.style.display = 'none';
                setConfigFormDisabled(false);
                return;
            }

            // 测试发送直接调用 morning_greeting 函数
            try {
                const response = await fetch(MORNING_GREETING_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configData),
                });
                
                // 记录原始响应
                const responseText = await response.text();
                console.log('来自morning_greeting的原始响应:', responseText);
                
                // 解析JSON
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error('解析响应JSON失败:', e);
                    throw new Error('服务器返回了无效的JSON数据');
                }
                
                console.log('Test send result:', result);
                loadingMessage.style.display = 'none';
                if (result.success) {
                    successMessage.textContent = `消息发送成功！ 请确认消息接收对象的微信上是否收到测试消息。重要提示：请点击"保存配置"按钮，才能保存配置信息，以便日后正常推送！`;
                    successMessage.style.display = 'block';
                } else {
                    errorMessage.textContent = `测试失败：${result.message || '未知错误，请检查后端日志。'}`;
                    errorMessage.style.display = 'block';
                }
            } catch (error) {
                console.error('Test send fetch error:', error);
                loadingMessage.style.display = 'none';
                errorMessage.textContent = `测试请求失败：${error.message}`;
                errorMessage.style.display = 'block';
            } finally {
                setConfigFormDisabled(false);
            }
        });

        // 保存配置按钮点击
        saveConfigButton.addEventListener('click', () => {
            clearMessages();
            if (!configForm.checkValidity()) {
                showMessage(errorMessage, '请填写所有必填项后再保存。', false);
                configForm.reportValidity();
                return;
            }

            // 弹出支付模态框
            currentPlan = null; // 重置选择
            currentOrderId = null;
            stopPaymentPolling(); // 停止之前的轮询
            document.querySelectorAll('.plan-option').forEach(el => el.classList.remove('selected'));
            paymentInfo.style.display = 'none';
            qrcodeContainer.innerHTML = ''; // 清空二维码
            confirmPaymentButton.disabled = true;
            paymentModal.show();
        });

        // 选择支付计划
        document.querySelectorAll('.plan-option').forEach(el => {
            el.addEventListener('click', () => {
                document.querySelectorAll('.plan-option').forEach(el => el.classList.remove('selected'));
                el.classList.add('selected');
                currentPlan = el.getAttribute('data-plan');
                confirmPaymentButton.disabled = false; // 启用确认支付按钮
                paymentInfo.style.display = 'none'; // 隐藏旧的支付信息
                paymentError.style.display = 'none';
                stopPaymentPolling();
            });
        });

        // 确认支付按钮点击
        confirmPaymentButton.addEventListener('click', async () => {
            if (!currentPlan) {
                paymentError.textContent = '请先选择一个订阅计划。';
                paymentError.style.display = 'block';
                return;
            }
            paymentError.style.display = 'none';
            confirmPaymentButton.disabled = true; // 防止重复点击
            confirmPaymentButton.textContent = '正在创建订单...';

            try {
                // 准备要保存的数据
                const configData = getFormData(configForm);
                const phone = document.getElementById('phone').value; // 获取认证表单的手机号
                const password = document.getElementById('password').value; // 获取认证表单的密码

                // 如果是注册流程，需要包含手机和密码
                const saveData = {
                    plan: currentPlan,
                    config: configData,
                    phone: phone, // 始终传递手机号
                    password: password // 传递密码用于注册或验证（后端决定如何使用）
                };

                // 调用后端创建支付订单接口
                const result = await apiCall('/api/payment/create-order', 'POST', saveData, !!authToken); // 如果有token则传递

                if (result.success && result.payment_info) {
                    currentOrderId = result.order_id;
                    paymentInfo.style.display = 'block';
                    qrcodeContainer.innerHTML = ''; // 清空旧二维码

                    // --- 这里需要根据支付服务商返回的信息展示支付方式 ---
                    const paymentInfo = result.payment_info;
                    if (paymentInfo.payment_type === 'form_redirect') {
                        // 记录订单ID用于后续查询
                        localStorage.setItem('current_payment_order_id', result.order_id);
                        
                        // 直接打开支付URL
                        window.open(paymentInfo.qr_code_url, '_blank');
                        
                        // 显示支付处理信息
                        document.getElementById('payment-qrcode').innerHTML = 
                            '<p>支付窗口已打开，如未跳转请<a href="' + paymentInfo.qr_code_url + 
                            '" target="_blank">点击此处</a>前往支付</p>';
                        
                        // 开始轮询支付状态
                        startPaymentPolling(result.order_id);
                    } else {
                        // 原始的二维码处理逻辑
                        document.getElementById('payment-qrcode').innerHTML = ''; // 清空之前的内容
                        new QRCode(document.getElementById('payment-qrcode'), paymentInfo.qr_code_url);
                        
                        // 开始轮询支付状态
                        startPaymentPolling(result.order_id);
                    }
                    // --- 支付方式展示结束 ---

                } else {
                    paymentError.textContent = result.message || '创建支付订单失败。';
                    paymentError.style.display = 'block';
                }

            } catch (error) {
                paymentError.textContent = `创建订单时出错: ${error.message}`;
                paymentError.style.display = 'block';
            } finally {
                 confirmPaymentButton.disabled = false;
                 confirmPaymentButton.textContent = '确认支付';
            }
        });

        // 开始轮询支付状态
        function startPaymentPolling(orderId) {
            stopPaymentPolling(); // 先停止旧的轮询
            paymentStatus.textContent = '正在查询支付状态...';
            let pollCount = 0;
            const maxPolls = 60; // 最多轮询约5分钟 (60 * 5秒)

            paymentPollInterval = setInterval(async () => {
                pollCount++;
                if (pollCount > maxPolls) {
                    stopPaymentPolling();
                    paymentStatus.textContent = '查询超时，请稍后在页面查看或联系客服。';
                    return;
                }

                try {
                    // 调用后端查询订单状态接口
                    const result = await apiCall(`/api/payment/status/${orderId}`, 'GET', null, !!authToken); // 可能需要认证

                    if (result.success && result.paid) {
                        stopPaymentPolling();
                        paymentStatus.textContent = '支付成功！配置已保存。';
                        paymentInfo.style.display = 'none'; // 隐藏支付信息
                        showMessage(successMessage, '支付成功！配置已成功保存。', true);
                        paymentModal.hide(); // 关闭模态框
                        // 如果是注册流程，需要模拟登录
                        if (!authToken) {
                            // 支付成功后后端应该已经完成了注册，尝试自动登录
                            const phone = document.getElementById('phone').value;
                            const password = document.getElementById('password').value;
                            // 延迟一点时间让后端处理完成
                            setTimeout(async () => {
                                try {
                                    const loginResult = await apiCall('/api/login', 'POST', { phone, password });
                                    if (loginResult.success && loginResult.token) {
                                        authToken = loginResult.token;
                                        loggedInUser = phone;
                                        localStorage.setItem('authToken', authToken);
                                        localStorage.setItem('loggedInUser', loggedInUser);
                                        updateLoginStatus(); // 更新状态并加载配置
                                    } else {
                                         showMessage(authMessage, '注册成功，但自动登录失败，请手动登录。', false);
                                    }
                                } catch (loginError) {
                                     showMessage(authMessage, '注册成功，但自动登录出错，请手动登录。', false);
                                }
                            }, 1500);
                        } else {
                            // 如果是已登录用户续费/更新，可能需要重新加载配置或状态
                            loadUserConfig();
                        }
                    } else if (result.success && !result.paid) {
                        paymentStatus.textContent = `等待支付... (查询次数: ${pollCount})`;
                    } else {
                        // 查询失败，但不停止轮询，给用户重试机会
                        paymentStatus.textContent = `查询支付状态失败: ${result.message || '未知错误'} (查询次数: ${pollCount})`;
                    }
                } catch (error) {
                    paymentStatus.textContent = `查询支付状态出错: ${error.message} (查询次数: ${pollCount})`;
                    // 网络错误等也暂时不停止轮询
                }
            }, 5000); // 每5秒查询一次
        }

        // 停止轮询
        function stopPaymentPolling() {
            if (paymentPollInterval) {
                clearInterval(paymentPollInterval);
                paymentPollInterval = null;
            }
        }

        // 模态框关闭时停止轮询
        paymentModalElement.addEventListener('hidden.bs.modal', () => {
            stopPaymentPolling();
        });

        // 初始化Bootstrap模态框
        document.addEventListener('DOMContentLoaded', function() {
            const paymentModalEl = document.getElementById('paymentModal');
            if (paymentModalEl) {
                const paymentModal = new bootstrap.Modal(paymentModalEl, {
                    backdrop: 'static',  // 不允许点击背景关闭
                    keyboard: false      // 不允许按ESC关闭
                });
                
                // 修改现有的显示模态框的代码
                window.showPaymentModal = function() {
                    paymentModal.show();
                };
                
                // 模态框关闭后的清理
                paymentModalEl.addEventListener('hidden.bs.modal', function() {
                    // 清理支付状态
                    if (document.getElementById('paymentQrcode')) {
                        document.getElementById('paymentQrcode').innerHTML = '';
                    }
                    if (document.getElementById('paymentError')) {
                        document.getElementById('paymentError').style.display = 'none';
                    }
                });
            }
        });

        // --- 初始化 ---
        // updateLoginStatus(); // 暂时注释掉，以防它内部有问题

        // 清理页面，只保留一个支付处理逻辑
        document.addEventListener('DOMContentLoaded', function() {
            console.log("初始化支付处理程序");
            
            // 查找已存在的支付按钮
            // 从模态框定义可以看出，支付按钮位于 #paymentModal 内部
            const monthlyBtn = document.querySelector('#paymentModal [data-plan="monthly"]');
            const yearlyBtn = document.querySelector('#paymentModal [data-plan="annual"]');
            
            console.log("月度按钮:", monthlyBtn ? "已找到" : "未找到");
            console.log("年度按钮:", yearlyBtn ? "已找到" : "未找到");
            
            // 为按钮添加点击处理
            if (monthlyBtn) {
                monthlyBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    handlePayment('monthly');
                });
            }
            
            if (yearlyBtn) {
                yearlyBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    handlePayment('annual');
                });
            }
            
            // 统一的支付处理函数
            function handlePayment(plan) {
                console.log("处理支付计划:", plan);
                
                // 收集用户信息和配置
                const phone = document.getElementById('phone').value;
                const password = document.getElementById('password').value;
                
                // 基本验证
                if (!phone || !password) {
                    alert("请输入手机号和密码");
                    return;
                }
                
                // 收集表单配置
                const config = {
                    app_id: document.getElementById('app_id').value || '',
                    app_secret: document.getElementById('app_secret').value || '',
                    user_openid: document.getElementById('user_openid').value || '',
                    template_id: document.getElementById('template_id').value || '',
                    location_name: document.getElementById('location_name').value || '',
                    adm_name: document.getElementById('adm_name').value || '',
                    meet_date: document.getElementById('meet_date').value || '',
                    partner_birthday: document.getElementById('partner_birthday').value || '',
                    xiazhou_birthday: document.getElementById('xiazhou_birthday').value || ''
                };
                
                // 记录支付前的配置数据
                console.log("支付过程中的用户配置数据:", JSON.stringify(config, null, 2));
                
                // 验证配置
                if (!config.app_id || !config.app_secret) {
                    alert("请填写微信公众号配置信息");
                    return;
                }
                
                // 验证关键参数
                if (!config.user_openid || !config.location_name || !config.adm_name) {
                    alert("请确保填写了微信用户ID、区县名和市/省名");
                    return;
                }
                
                // 显示加载状态
                const paymentLoading = document.getElementById('paymentLoading');
                const paymentError = document.getElementById('paymentError');
                
                if (paymentLoading) paymentLoading.style.display = 'block';
                if (paymentError) paymentError.style.display = 'none';
                
                // 提示用户
                console.log("正在发送支付请求...");
                
                // 保存当前配置到sessionStorage，以便支付完成后能恢复
                sessionStorage.setItem('pendingConfig', JSON.stringify(config));
                sessionStorage.setItem('pendingPhone', phone);
                sessionStorage.setItem('pendingPassword', password);
                sessionStorage.setItem('pendingPlan', plan);
                
                // 发送请求
                fetch('https://1337331310-2gg2yrldrk.ap-beijing.tencentscf.com/api/payment/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        plan: plan,
                        phone: phone,
                        password: password,
                        config: config
                    })
                })
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('请求失败: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(data) {
                    console.log("支付API响应:", data);
                    
                    if (paymentLoading) paymentLoading.style.display = 'none';
                    
                    if (data.success && data.payment_info) {
                        // 保存订单ID用于后续查询
                        if (data.order_id) {
                            sessionStorage.setItem('currentOrderId', data.order_id);
                            console.log("已保存订单ID:", data.order_id);
                        }
                        
                        // 创建并提交支付表单
                        console.log("准备提交支付表单...");
                        var div = document.createElement('div');
                        div.style.display = 'none';
                        div.innerHTML = data.payment_info.redirect_form;
                        document.body.appendChild(div);
                        
                        // 延迟执行以确保表单添加到DOM
                        setTimeout(function() {
                            const form = document.getElementById('payform');
                            if (form) {
                                console.log("提交支付表单");
                                form.submit();
                            } else {
                                console.log("表单未找到，使用支付链接");
                                window.location.href = data.payment_info.qr_code_url;
                            }
                        }, 300);
                    } else {
                        if (paymentError) {
                            paymentError.textContent = data.message || '创建订单失败';
                            paymentError.style.display = 'block';
                        } else {
                            alert('创建订单失败: ' + (data.message || '未知错误'));
                        }
                    }
                })
                .catch(function(error) {
                    console.error('支付处理错误:', error);
                    
                    if (paymentLoading) paymentLoading.style.display = 'none';
                    
                    if (paymentError) {
                        paymentError.textContent = error.message;
                        paymentError.style.display = 'block';
                    } else {
                        alert('支付处理错误: ' + error.message);
                    }
                });
            }
        });

        // 在支付状态查询成功的地方添加日志
        function checkPaymentStatus() {
            // 现有代码...
            if (result.success && result.paid) {
                console.log("支付成功，准备存储用户配置");
                // 获取之前保存的配置
                const savedConfig = JSON.parse(sessionStorage.getItem('pendingConfig') || '{}');
                const savedPhone = sessionStorage.getItem('pendingPhone');
                console.log("恢复的用户配置:", JSON.stringify(savedConfig, null, 2));
                console.log("恢复的用户手机:", savedPhone);
                
                // 确保wx_config_api收到正确数据
                // 现有的存储逻辑...
            }
        }

        // 确保处理支付结果页面时恢复配置
        document.addEventListener('DOMContentLoaded', function() {
            // 检查URL是否是支付结果页
            if (window.location.pathname === '/payment-result') {
                console.log("检测到支付结果页面，准备处理结果");
                
                // 从sessionStorage获取信息
                const pendingConfig = sessionStorage.getItem('pendingConfig');
                const pendingPhone = sessionStorage.getItem('pendingPhone');
                
                if (pendingConfig && pendingPhone) {
                    console.log("发现待处理的配置信息:", pendingConfig);
                    // 可以在这里添加向wx_config_api发送最终确认存储的请求
                } else {
                    console.warn("未找到待处理的配置信息");
                }
            }
        });
    </script>
</body>
</html> 
