<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信早安推送配置</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .container { max-width: 700px; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .form-label { font-weight: bold; }
        .alert { margin-top: 20px; }
        .required::after { content: '*'; color: red; margin-left: 2px; }
        /* 新增样式 */
        .auth-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .config-section { display: none; /* 默认隐藏配置区域 */ }
        .user-status { margin-bottom: 15px; font-style: italic; }
        .tutorial-link { margin-bottom: 20px; padding: 10px; background-color: #e9f5ff; border: 1px solid #b3d7ff; border-radius: 5px; }
        .payment-modal-body { /* 支付模态框样式 */ }
        .plan-option { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; }
        .plan-option.selected { border-color: #0d6efd; background-color: #e7f1ff; }
        .plan-option h5 { margin-top: 0; }
        .form-section {
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            padding: 25px;
            background-color: #fff;
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            color: #3a5a78;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
        }
        
        .form-label.required:after {
            content: "*";
            color: red;
            margin-left: 4px;
        }
        
        .btn-primary {
            background-color: #3a5a78;
            border-color: #3a5a78;
        }
        
        .btn-info {
            background-color: #5bc0de;
            border-color: #5bc0de;
            color: white;
        }
        
        .alert-custom-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .alert-custom-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
    <!-- Google Analytics 代码 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=YOUR_ANALYTICS_ID"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'YOUR_ANALYTICS_ID');
    </script>
    <!-- 百度统计代码 -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?YOUR_SITE_ID";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body>
    <div class="container">
        <div class="alert alert-warning mb-4 border-left border-warning" style="border-left: 5px solid #ffc107; font-size: 1.1rem;">
            <h4 class="alert-heading text-center mb-3"><i class="bi bi-exclamation-triangle-fill me-2"></i>重要使用说明</h4>
            <p>使用前请务必阅读<a href="https://bcn1jsdnj3t6.feishu.cn/wiki/DRsNwylmAiJxVokNmfnczd5XnMa" class="alert-link" target="_blank">详细使用教程</a>，了解各项配置含义以及获取方法！</p>
            <hr>
            <ol class="mb-0">
                <li>您需要<strong>先测试发送</strong>确认配置正确，再保存配置</li>
                <li>保存成功后，系统会<strong>每天自动发送</strong>天气、纪念日等信息</li>
                <li>请确保带<strong style="color: red;">*</strong>号的必填信息准确无误，特别是<strong>AppID和AppSecret</strong></li>
            </ol>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>微信推送配置</h2>
        </div>
        
        <!-- 使用前必看教程 -->
        <div class="tutorial-link">
            <strong>重要提示：</strong> 使用前请务必查看 <a href="https://bcn1jsdnj3t6.feishu.cn/wiki/DRsNwylmAiJxVokNmfnczd5XnMa" target="_blank" rel="noopener noreferrer">详细使用教程</a>，了解各项配置含义及获取方法！
        </div>
        
        <!-- 用户认证表单 -->
        <div id="authForm" class="mb-4">
            <h4>用户信息</h4>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="phone" class="form-label">手机号码</label>
                    <input type="tel" class="form-control" id="phone" placeholder="请输入手机号码">
                </div>
                <div class="col-md-6">
                    <label for="password" class="form-label">密码</label>
                    <input type="password" class="form-control" id="password" placeholder="请设置密码">
                </div>
            </div>
        </div>
        
        <!-- 添加套餐选择部分，包含新的年付52元套餐 -->
        <div class="mb-4">
            <h4>请选择订阅套餐</h4>
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="plan" id="planMonthly" value="monthly" checked>
                <label class="form-check-label" for="planMonthly">
                    月付 <span id="priceMonthly">1</span>元 - 每天自动发送早安问候给伴侣
                </label>
            </div>
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="plan" id="planAnnual" value="annual">
                <label class="form-check-label" for="planAnnual">
                    年付 <span id="priceAnnual">2</span>元 - 每天自动发送早安问候给伴侣（相当于<span id="discountMonthly">免费用1个月</span>）
                </label>
            </div>
            <div class="form-check mb-2">
                <input class="form-check-input" type="radio" name="plan" id="planDual" value="dual">
                <label class="form-check-label" for="planDual">
                    年付 <span id="priceDual">52</span>元 - 每天同时自动发送早安问候给您和伴侣
                </label>
            </div>
        </div>
        
        <!-- 添加配置区域标题 -->
        <div class="mb-3">
            <h4>伴侣微信配置</h4>
        </div>
        
        <!-- 配置区域 -->
        <div class="config-section" id="configSection">
            <form id="configForm">
                <!-- 用户ID (登录后自动填充或隐藏) -->
                <input type="hidden" id="user_id" name="user_id">

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="app_id" class="form-label required">微信公众号AppID</label>
                        <input type="text" class="form-control" id="app_id" name="app_id" required>
                    </div>
                    <div class="col-md-6">
                        <label for="app_secret" class="form-label required">微信公众号AppSecret</label>
                        <input type="password" class="form-control" id="app_secret" name="app_secret" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="partner_openid" class="form-label required">伴侣的OpenID</label>
                        <input type="text" class="form-control" id="partner_openid" name="user_openid" required>
                    </div>
                    <div class="col-md-6">
                        <label for="template_id" class="form-label required">早安模板ID</label>
                        <input type="text" class="form-control" id="template_id" name="template_id" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="indices_template_id" class="form-label">天气指数模板ID (可选)</label>
                        <input type="text" class="form-control" id="indices_template_id" name="indices_template_id">
                    </div>
                    <div class="col-md-6">
                        <label for="location_name" class="form-label required">天气查询-区县名</label>
                        <input type="text" class="form-control" id="location_name" name="location_name" required placeholder="例如: 朝阳区">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="adm_name" class="form-label required">天气查询-市/省名</label>
                        <input type="text" class="form-control" id="adm_name" name="adm_name" required placeholder="例如: 北京市 或 河北省">
                    </div>
                    <div class="col-md-6">
                        <label for="meet_date" class="form-label">相爱纪念日 (可选)</label>
                        <input type="date" class="form-control" id="meet_date" name="meet_date">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="partner_birthday" class="form-label">你的生日 (可选)</label>
                        <input type="date" class="form-control" id="partner_birthday" name="partner_birthday">
                    </div>
                    <div class="col-md-6">
                        <label for="xiazhou_birthday" class="form-label">Ta的生日 (可选)</label>
                        <input type="date" class="form-control" id="xiazhou_birthday" name="xiazhou_birthday">
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button id="testButton" type="button" class="btn btn-info me-md-2">
                        <i class="bi bi-send"></i> 测试发送
                    </button>
                    <button id="saveButton" type="button" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> 保存配置
                    </button>
                </div>
            </form>
        </div>

        <!-- 添加用户本人配置区域，仅在选择双人套餐时显示 -->
        <div id="userConfigSection" class="mt-4" style="display: none;">
            <h4>您的个人微信配置</h4>
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <label for="self_openid" class="form-label">您的微信OpenID</label>
                    <input type="text" class="form-control" id="self_openid" placeholder="请输入您的微信OpenID">
                </div>
                <div class="col-md-6">
                    <label for="user_location_name" class="form-label">您所在的区县</label>
                    <input type="text" class="form-control" id="user_location_name" placeholder="例如：海淀区">
                </div>
                <div class="col-md-6">
                    <label for="user_adm_name" class="form-label">您所在的城市</label>
                    <input type="text" class="form-control" id="user_adm_name" placeholder="例如：北京市">
                </div>
            </div>
        </div>
        
        <!-- 加载中提示 -->
        <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">处理中，请稍候...</p>
        </div>
    </div>
    
    <!-- 支付模态框 -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">订阅计划</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 计划选择部分 -->
                    <div id="planSelection">
                        <h5 class="mb-3">请选择您的订阅计划:</h5>
                        <div class="plan-option" data-plan="monthly">
                            <h5>月度订阅</h5>
                            <p class="mb-1">价格: <span class="price-monthly">24.90</span>元/月</p>
                            <p class="mb-0 text-muted">每月自动续费，可随时取消</p>
                        </div>
                        <div class="plan-option" data-plan="annual">
                            <h5>年度订阅</h5>
                            <p class="mb-1">价格: <span class="price-annual">59.90</span>元/年</p>
                            <p class="mb-0 text-muted">比月付更划算，节省80%</p>
                        </div>
                    </div>

                    <!-- 支付加载中状态 -->
                    <div id="paymentLoading" style="display:none;">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                            <p class="mt-3">正在创建支付订单，请稍候...</p>
                        </div>
                    </div>
                </div>
                
                <!-- 支付信息显示 -->
                <div id="paymentInfo" style="display:none;">
                    <p id="paymentStatus" class="text-center mb-3">请完成支付...</p>
                    
                    <!-- 二维码支付 -->
                    <div id="qrCodeContainer" class="text-center py-2" style="display:none;">
                        <img id="qrCodeImage" class="img-fluid mb-3" style="max-width: 200px;" alt="支付二维码">
                        <button id="directPayButton" class="btn btn-primary btn-sm" style="display:none;">
                            打开支付页面
                        </button>
                    </div>
                    
                    <!-- 表单重定向支付 -->
                    <div id="formRedirectContainer" class="text-center py-2" style="display:none;">
                        <p>即将跳转到支付页面，请稍候...</p>
                        <div id="formRedirectContent"></div>
                    </div>
                    
                    <!-- 支付链接 -->
                    <div id="paymentLinkContainer" class="text-center py-2" style="display:none;">
                        <a id="paymentLink" href="#" class="btn btn-success" target="_blank">
                            点击前往支付
                        </a>
                    </div>
                </div>
                
                <!-- 支付错误信息 -->
                <div id="paymentError" class="alert alert-danger" style="display:none;"></div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button id="confirmPaymentButton" type="button" class="btn btn-primary">确认订阅</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 修改页脚联系信息 -->
    <footer class="mt-5 text-center text-muted">
        <p>微信公众号：简的小屋子，发送你的问题，我们将为您提供服务。</p>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API 端点 (根据您的实际部署修改)
        const API_BASE_URL = 'https://1337331310-2gg2yrldrk.ap-beijing.tencentscf.com'; // wx_config_api 的 URL
        const MORNING_GREETING_URL = 'https://1337331310-kko6t1lktu.ap-beijing.tencentscf.com'; // morning_greeting 的 URL

        // DOM 元素
        const authForm = document.getElementById('authForm');
        const configForm = document.getElementById('configForm');
        const configSection = document.getElementById('configSection');
        const userConfigSection = document.getElementById('userConfigSection');
        const saveButton = document.getElementById('saveButton');
        const testButton = document.getElementById('testButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        
        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', function() {
            // 显示配置部分
            configSection.style.display = 'block';
            
            // 获取价格信息
            fetchPriceInfo();
            
            // 监听套餐选择改变事件
            document.querySelectorAll('input[name="plan"]').forEach(function(radio) {
                radio.addEventListener('change', function() {
                    if (this.value === 'dual') {
                        userConfigSection.style.display = 'block';
                    } else {
                        userConfigSection.style.display = 'none';
                    }
                });
            });
            
            // 保存按钮点击事件
            saveButton.addEventListener('click', function() {
                // 获取手机号和密码
                const phone = document.getElementById('phone').value;
                const password = document.getElementById('password').value;
                
                // 验证基本信息
                if (!phone || !password) {
                    alert('请输入手机号和密码');
                    return;
                }
                
                // 收集配置信息
                const config = collectConfigData();
                
                // 验证必填字段
                if (!validateConfig(config)) {
                    return;
                }
                
                // 获取选中的套餐
                const plan = document.querySelector('input[name="plan"]:checked').value;
                
                // 创建订单并处理支付
                createOrderAndPay(phone, password, config, plan);
            });
            
            // 测试发送按钮点击事件
            testButton.addEventListener('click', function() {
                // 收集伴侣配置信息
                const partnerConfig = collectConfigData();
                
                // 验证必要字段
                if (!validateConfig(partnerConfig)) {
                    return;
                }
                
                // 发送给伴侣的早安问候
                sendTestMessage(partnerConfig, false);
                
                // 如果选择了双人套餐，也发送给用户本人
                const plan = document.querySelector('input[name="plan"]:checked').value;
                if (plan === 'dual') {
                    // 创建用户本人的配置，基于伴侣配置
                    const userConfig = {...partnerConfig};
                    
                    // 用户的OpenID和地理位置
                    userConfig.user_openid = document.getElementById('self_openid').value;
                    userConfig.location_name = document.getElementById('user_location_name').value;
                    userConfig.adm_name = document.getElementById('user_adm_name').value;
                    
                    // 交换生日信息
                    [userConfig.partner_birthday, userConfig.xiazhou_birthday] = 
                        [userConfig.xiazhou_birthday, userConfig.partner_birthday];
                    
                    // 发送给用户本人的早安问候
                    sendTestMessage(userConfig, true);
                }
            });
        });
        
        // 获取价格信息
        function fetchPriceInfo() {
            fetch(`${API_BASE_URL}/api/price`)
                .then(response => response.json())
                .then(data => {
                    // 更新页面上的价格显示
                    document.getElementById('priceMonthly').textContent = data.monthly;
                    document.getElementById('priceAnnual').textContent = data.annual;
                    document.getElementById('priceDual').textContent = data.dual;
                    
                    // 计算月付年付的差价
                    const monthlyPrice = parseFloat(data.monthly);
                    const annualPrice = parseFloat(data.annual);
                    const savingMonths = Math.round((monthlyPrice * 12 - annualPrice) / monthlyPrice);
                    
                    document.getElementById('discountMonthly').textContent = `免费用${savingMonths}个月`;
                })
                .catch(error => {
                    console.error('获取价格信息失败:', error);
                });
        }
        
        // 收集配置信息
        function collectConfigData() {
            return {
                app_id: document.getElementById('app_id').value,
                app_secret: document.getElementById('app_secret').value,
                user_openid: document.getElementById('partner_openid').value,
                template_id: document.getElementById('template_id').value,
                indices_template_id: document.getElementById('indices_template_id').value,
                location_name: document.getElementById('location_name').value,
                adm_name: document.getElementById('adm_name').value,
                meet_date: document.getElementById('meet_date').value,
                partner_birthday: document.getElementById('partner_birthday').value,
                xiazhou_birthday: document.getElementById('xiazhou_birthday').value
            };
        }
        
        // 验证配置信息
        function validateConfig(config) {
            const requiredFields = ['app_id', 'app_secret', 'user_openid', 'template_id', 'location_name', 'adm_name'];
            const missingFields = requiredFields.filter(field => !config[field]);
            
            if (missingFields.length > 0) {
                alert(`请填写必要的配置信息: ${missingFields.join(', ')}`);
                return false;
            }
            
            return true;
        }
        
        // 创建订单并处理支付
        function createOrderAndPay(phone, password, config, plan) {
            // 显示加载中
            loadingSpinner.style.display = 'block';
            
            // 创建订单
            fetch(`${API_BASE_URL}/api/payment/create`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    phone: phone,
                    password: password,
                    plan: plan,
                    config: config
                })
            })
            .then(response => response.json())
            .then(data => {
                loadingSpinner.style.display = 'none';
                
                if (data.success) {
                    // 保存订单信息和配置到会话
                    sessionStorage.setItem('pendingConfig', JSON.stringify(config));
                    sessionStorage.setItem('pendingPhone', phone);
                    sessionStorage.setItem('pendingPassword', password);
                    sessionStorage.setItem('pendingPlan', plan);
                    sessionStorage.setItem('currentOrderId', data.order_id);
                    
                    // 处理支付
                    handlePayment(data.payment_info);
                } else {
                    alert(data.message || '创建订单失败');
                }
            })
            .catch(error => {
                console.error('创建订单失败:', error);
                alert('创建订单失败，请稍后再试');
                loadingSpinner.style.display = 'none';
            });
        }
        
        // 处理支付信息
        function handlePayment(paymentInfo) {
            if (paymentInfo.payment_type === 'qrcode') {
                // 显示二维码
                document.getElementById('qrCodeImage').src = paymentInfo.qr_code_url;
                document.getElementById('qrCodeContainer').style.display = 'block';
                
                // 显示支付模态框
                paymentModal.show();
            } else if (paymentInfo.payment_type === 'form_redirect') {
                // 创建并提交表单，跳转到支付页面
                const formContainer = document.createElement('div');
                formContainer.innerHTML = paymentInfo.redirect_form;
                document.body.appendChild(formContainer);
                
                // 自动提交表单
                const form = formContainer.querySelector('form');
                if (form) {
                    form.submit();
                }
            } else if (paymentInfo.payment_type === 'redirect') {
                // 跳转到支付页面
                window.location.href = paymentInfo.redirect_url;
            }
        }
        
        // 支付成功回调
        function paymentSuccess() {
            // 获取缓存的信息
            const plan = sessionStorage.getItem('pendingPlan');
            const phone = sessionStorage.getItem('pendingPhone');
            const password = sessionStorage.getItem('pendingPassword');
            const config = JSON.parse(sessionStorage.getItem('pendingConfig') || '{}');
            
            // 保存伴侣配置
            saveUserConfig(phone, password, config, plan, false);
            
            // 如果是双人套餐，还需保存用户本人的配置
            if (plan === 'dual') {
                // 创建用户本人的配置
                const userConfig = {...config};
                
                // 用户的OpenID和地理位置
                userConfig.user_openid = document.getElementById('self_openid').value;
                userConfig.location_name = document.getElementById('user_location_name').value;
                userConfig.adm_name = document.getElementById('user_adm_name').value;
                
                // 交换生日信息
                [userConfig.partner_birthday, userConfig.xiazhou_birthday] = 
                    [userConfig.xiazhou_birthday, userConfig.partner_birthday];
                    
                // 保存用户配置
                saveUserConfig(phone, password, userConfig, plan, true);
            }
            
            // 显示成功消息
            alert('支付成功！您的配置已保存。');
            
            // 清除缓存的信息
            sessionStorage.removeItem('pendingConfig');
            sessionStorage.removeItem('pendingPhone');
            sessionStorage.removeItem('pendingPassword');
            sessionStorage.removeItem('pendingPlan');
            sessionStorage.removeItem('currentOrderId');
        }
        
        // 保存用户配置
        function saveUserConfig(phone, password, config, plan, isUserConfig) {
            fetch(`${API_BASE_URL}/api/payment/complete-setup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    phone: phone,
                    password: password,
                    config: config,
                    plan: plan,
                    order_id: sessionStorage.getItem('currentOrderId'),
                    is_user_config: isUserConfig
                })
            })
            .then(response => response.json())
            .then(result => {
                console.log('配置保存结果:', result);
            })
            .catch(error => {
                console.error('保存配置失败:', error);
            });
        }
        
        // 发送测试消息
        function sendTestMessage(config, isUser) {
            loadingSpinner.style.display = 'block';
            
            // 调用morning_greeting云函数发送测试消息
            fetch(`${MORNING_GREETING_URL}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const recipient = isUser ? '您' : '伴侣';
                    alert(`发送给${recipient}的测试消息成功！`);
                } else {
                    const recipient = isUser ? '您' : '伴侣';
                    alert(`发送给${recipient}的测试消息失败: ${data.message}`);
                }
                loadingSpinner.style.display = 'none';
            })
            .catch(error => {
                console.error('发送测试消息失败:', error);
                const recipient = isUser ? '您' : '伴侣';
                alert(`发送给${recipient}的测试消息失败，请检查配置信息`);
                loadingSpinner.style.display = 'none';
            });
        }
        
        // 检查URL参数中是否有支付成功标记
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentResult = urlParams.get('payment_result');
            
            if (paymentResult === 'success') {
                paymentSuccess();
                
                // 移除URL参数
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });
    </script>
    
    <!-- 51LA统计代码 - 放在body结束标签前 -->
    <script type="text/javascript" src="//js.users.51.la/21954557.js"></script>
</body>
</html> 
