<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>微信早安推送配置</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .container { max-width: 700px; background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .form-label { font-weight: bold; }
        .alert { margin-top: 20px; }
        .required::after { content: '*'; color: red; margin-left: 2px; }
        /* 新增样式 */
        .auth-section { margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        .config-section { display: none; /* 默认隐藏配置区域 */ }
        .user-status { margin-bottom: 15px; font-style: italic; }
        .tutorial-link { margin-bottom: 20px; padding: 10px; background-color: #e9f5ff; border: 1px solid #b3d7ff; border-radius: 5px; }
        .payment-modal-body { /* 支付模态框样式 */ }
        .plan-option { border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; }
        .plan-option.selected { border-color: #0d6efd; background-color: #e7f1ff; }
        .plan-option h5 { margin-top: 0; }
        .form-section {
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            padding: 25px;
            background-color: #fff;
            margin-bottom: 30px;
        }
        
        .form-section h3 {
            color: #3a5a78;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eaeaea;
        }
        
        .form-label.required:after {
            content: "*";
            color: red;
            margin-left: 4px;
        }
        
        .btn-primary {
            background-color: #3a5a78;
            border-color: #3a5a78;
        }
        
        .btn-info {
            background-color: #5bc0de;
            border-color: #5bc0de;
            color: white;
        }
        
        .alert-custom-success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .alert-custom-error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
    </style>
    <!-- Google Analytics 代码 -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=YOUR_ANALYTICS_ID"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'YOUR_ANALYTICS_ID');
    </script>
    <!-- 百度统计代码 -->
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?YOUR_SITE_ID";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
    </script>
</head>
<body>
    <div class="container">
        <div class="alert alert-warning mb-4 border-left border-warning" style="border-left: 5px solid #ffc107; font-size: 1.1rem;">
            <h4 class="alert-heading text-center mb-3"><i class="bi bi-exclamation-triangle-fill me-2"></i>重要使用说明</h4>
            <p>使用前请务必阅读<a href="https://bcn1jsdnj3t6.feishu.cn/wiki/DRsNwylmAiJxVokNmfnczd5XnMa" class="alert-link" target="_blank">详细使用教程</a>，了解各项配置含义以及获取方法！</p>
            <hr>
            <ol class="mb-0">
                <li>您需要<strong>先测试发送</strong>确认配置正确，再保存配置</li>
                <li>保存成功后，系统会<strong>每天自动发送</strong>天气、纪念日等信息</li>
                <li>请确保带<strong style="color: red;">*</strong>号的必填信息准确无误，特别是<strong>AppID和AppSecret</strong></li>
            </ol>
        </div>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>微信推送配置</h2>
        </div>
        
        <!-- 使用前必看教程 -->
        <div class="tutorial-link">
            <strong>重要提示：</strong> 使用前请务必查看 <a href="https://bcn1jsdnj3t6.feishu.cn/wiki/DRsNwylmAiJxVokNmfnczd5XnMa" target="_blank" rel="noopener noreferrer">详细使用教程</a>，了解各项配置含义及获取方法！
                </div>
                
        <!-- 用户认证表单 -->
        <div id="authForm" class="mb-4">
            <h4>用户信息</h4>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="phone" class="form-label">手机号码</label>
                    <input type="tel" class="form-control" id="phone" placeholder="请输入手机号码">
                </div>
                <div class="col-md-6">
                    <label for="password" class="form-label">密码</label>
                    <input type="password" class="form-control" id="password" placeholder="请设置密码">
                </div>
            </div>
        </div>
        
        <!-- 添加配置区域标题 -->
        <div class="mb-3">
            <h4>伴侣微信配置</h4>
        </div>
        
        <!-- 配置区域 -->
        <div class="config-section" id="configSection">
            <form id="configForm">
                <!-- 用户ID (登录后自动填充或隐藏) -->
                <input type="hidden" id="user_id" name="user_id">

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="app_id" class="form-label required">微信公众号AppID</label>
                        <input type="text" class="form-control" id="app_id" name="app_id" required>
                    </div>
                    <div class="col-md-6">
                        <label for="app_secret" class="form-label required">微信公众号AppSecret</label>
                        <input type="password" class="form-control" id="app_secret" name="app_secret" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="partner_openid" class="form-label required">伴侣的OpenID</label>
                        <input type="text" class="form-control" id="partner_openid" name="user_openid" required>
                    </div>
                    <div class="col-md-6">
                        <label for="template_id" class="form-label required">早安模板ID</label>
                        <input type="text" class="form-control" id="template_id" name="template_id" required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="indices_template_id" class="form-label">天气指数模板ID (可选)</label>
                        <input type="text" class="form-control" id="indices_template_id" name="indices_template_id">
                    </div>
                    <div class="col-md-6">
                        <label for="location_name" class="form-label required">天气查询-区县名</label>
                        <input type="text" class="form-control" id="location_name" name="location_name" required placeholder="例如: 朝阳区">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="adm_name" class="form-label required">天气查询-市/省名</label>
                        <input type="text" class="form-control" id="adm_name" name="adm_name" required placeholder="例如: 北京市 或 河北省">
                    </div>
                    <div class="col-md-6">
                        <label for="meet_date" class="form-label">相爱纪念日 (可选)</label>
                        <input type="date" class="form-control" id="meet_date" name="meet_date">
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="partner_birthday" class="form-label">你的生日 (可选)</label>
                        <input type="date" class="form-control" id="partner_birthday" name="partner_birthday">
                    </div>
                    <div class="col-md-6">
                        <label for="xiazhou_birthday" class="form-label">Ta的生日 (可选)</label>
                        <input type="date" class="form-control" id="xiazhou_birthday" name="xiazhou_birthday">
                    </div>
                </div>
                
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button id="testButton" type="button" class="btn btn-info me-md-2">
                        <i class="bi bi-send"></i> 测试发送
                    </button>
                </div>
            </form>
            
            <hr class="my-4">
            
            <!-- 用户本人配置区域 -->
            <div id="userConfigSection" class="mt-4">
                <h4>您的个人微信配置</h4>
                <div class="form-section auth-section">
                    <h3>个人信息配置</h3>
                    <div class="mb-3">
                        <label for="userOpenid" class="form-label required">您的微信OpenID</label>
                        <input type="text" class="form-control" id="userOpenid" placeholder="请输入您的微信OpenID">
                        <div class="form-text">用于接收每日通知的微信ID</div>
                    </div>
                    
                    <!-- 添加模板ID输入字段 -->
                    <div class="mb-3">
                        <label for="userTemplateId" class="form-label required">您的模板ID</label>
                        <input type="text" class="form-control" id="userTemplateId" placeholder="请输入您的微信模板ID">
                        <div class="form-text">用于发送每日通知的模板ID</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="locationName" class="form-label required">区/县</label>
                        <input type="text" class="form-control" id="locationName" placeholder="例如：海淀区">
                    </div>
                    
                    <div class="mb-3">
                        <label for="admName" class="form-label required">城市</label>
                        <input type="text" class="form-control" id="admName" placeholder="例如：北京市">
                    </div>
                </div>
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button id="testSelfButton" type="button" class="btn btn-info">
                        <i class="bi bi-send"></i> 测试发送给您自己
                    </button>
                </div>
            </div>
            
            <!-- 将所有区域的保存按钮放在最下方 -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                <button id="saveButton" type="button" class="btn btn-primary btn-lg">
                    <i class="bi bi-check-circle"></i> 保存配置
                </button>
            </div>
        </div>
        
        <!-- 加载中提示 -->
        <div id="loadingSpinner" class="text-center mt-3" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">加载中...</span>
            </div>
            <p class="mt-2">处理中，请稍候...</p>
        </div>
    </div>
    
    <!-- 修改支付模态框，添加套餐选择 -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">选择订阅方案</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 套餐选择部分 -->
                    <div id="planSelection">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="modal-plan" id="monthlyPlan" value="monthly" checked>
                            <label class="form-check-label" for="monthlyPlan">
                                月度套餐 - ¥<span id="modalPriceMonthly">24.9</span>
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="modal-plan" id="annualPlan" value="annual">
                            <label class="form-check-label" for="annualPlan">
                                年度套餐 - ¥<span id="modalPriceAnnual">29.9</span>
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="modal-plan" id="dualPlan" value="dual">
                            <label class="form-check-label" for="dualPlan">
                                双人套餐 - ¥<span id="modalPriceDual">1</span>
                            </label>
                        </div>
                        
                        <div class="mb-3">
                            <label for="phone" class="form-label">手机号码</label>
                            <input type="tel" class="form-control" id="phone" placeholder="请输入您的手机号码" required>
                        </div>
                    </div>
                    
                    <!-- 二维码部分 - 这部分是缺失的 -->
                    <div id="qrcodeSection" style="display:none;" class="text-center">
                        <h5 class="mb-3">请使用支付宝扫码支付</h5>
                        <img id="paymentQrcode" src="" alt="支付二维码" class="img-fluid mb-3" style="max-width: 200px;">
                        <div class="mb-3">
                            <a id="paymentLink" href="#" target="_blank" class="btn btn-outline-primary" style="display:none;">
                                <i class="bi bi-link-45deg"></i> 打开支付页面
                            </a>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> 支付完成后，请点击下方"我已完成支付"按钮
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <div>
                        <button id="confirmPaymentButton" type="button" class="btn btn-primary">确认订阅</button>
                        <button id="paymentCompleteButton" type="button" class="btn btn-success" style="display:none;">我已完成支付</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 修改页脚联系信息 -->
    <footer class="mt-5 text-center text-muted">
        <p>微信公众号：简的小屋子，发送你的问题，我们将为您提供服务。</p>
    </footer>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 使用实际的云函数URL
        const API_BASE_URL = 'https://1337331310-2gg2yrldrk.ap-beijing.tencentscf.com'; // 微信配置云函数 
        const MORNING_GREETING_URL = 'https://1337331310-kko6t1lktu.ap-beijing.tencentscf.com'; // 早安问候云函数
        
        // DOM元素
        const configForm = document.getElementById('configForm');
        const saveButton = document.getElementById('saveButton');
        const testButton = document.getElementById('testButton');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const configSection = document.getElementById('configSection');
        const confirmPaymentButton = document.getElementById('confirmPaymentButton');
        const paymentCompleteButton = document.getElementById('paymentCompleteButton');
        
        // 支付相关
        const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
        
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，当前API基础URL:', API_BASE_URL);
            
            // 如果API_BASE_URL未定义或为空，使用默认值
            if (!window.API_BASE_URL) {
                window.API_BASE_URL = 'https://1387331310-2gg2yrldkk.ap-beijing.tencentscf.com';
                console.log('API_BASE_URL未定义，使用默认值:', API_BASE_URL);
            }
            
            // 测试API连接
            fetch(`${API_BASE_URL}/api/price`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('测试API连接状态:', response.status);
                if (response.ok) {
                    console.log('API连接正常');
                } else {
                    console.warn('API连接异常，状态码:', response.status);
                }
            })
            .catch(error => {
                console.error('API连接测试失败:', error);
            });
            
            // 从API获取价格信息
            fetchPriceInfo();
            
            // 显示配置部分
            configSection.style.display = 'block';
            
            // 测试发送给伴侣按钮点击事件
            testButton.addEventListener('click', function() {
                const config = collectConfigData();
                if (validateConfig(config)) {
                    sendTestMessage(config, false);
                }
            });
            
            // 测试发送给自己按钮点击事件
            document.getElementById('testSelfButton').addEventListener('click', function() {
                const partnerConfig = collectConfigData();
                const userConfig = collectUserConfigData(partnerConfig);
                
                if (validateUserConfig(userConfig)) {
                    sendTestMessage(userConfig, true);
                }
            });
            
            // 保存配置按钮点击事件
            saveButton.addEventListener('click', function() {
                // 获取用户信息和配置
                const phone = document.getElementById('phone').value;
                const password = document.getElementById('password').value;
                const config = collectConfigData();
                
                if (!phone || !password) {
                    alert('请填写手机号和密码');
                    return;
                }
                
                if (!validateConfig(config)) {
                    return;
                }
                
                // 保存用户本人配置以备后用
                const userConfig = collectUserConfigData(config);
                
                // 保存临时信息
                sessionStorage.setItem('pendingPhone', phone);
                sessionStorage.setItem('pendingPassword', password);
                sessionStorage.setItem('pendingConfig', JSON.stringify(config));
                sessionStorage.setItem('pendingUserConfig', JSON.stringify(userConfig));
                
                // 显示套餐选择模态框
                showPaymentModal();
            });
            
            // 确认订阅按钮点击事件
            document.getElementById('confirmPaymentButton').addEventListener('click', function() {
                try {
                    console.log('确认订阅按钮被点击');
                    
                    // 获取选中的套餐
                    const selectedPlanElement = document.querySelector('input[name="modal-plan"]:checked');
                    if (!selectedPlanElement) {
                        alert('请选择一个套餐');
                        return;
                    }
                    
                    const selectedPlan = selectedPlanElement.value;
                    console.log('选择的套餐:', selectedPlan);
                    
                    // 从页面中获取信息
                    const phone = document.getElementById('phone').value;
                    console.log('电话号码:', phone);
                    
                    if (!phone) {
                        alert('请填写手机号');
                        return;
                    }
                    
                    // 收集配置信息
                    const config = collectConfigData();
                    if (!config) {
                        alert('配置信息收集失败');
                        return;
                    }
                    
                    // 如果是双人套餐，检查用户本人配置
                    if (selectedPlan === 'dual') {
                        // 使用正确的元素ID
                        const userOpenid = document.getElementById('userOpenid');
                        const locationName = document.getElementById('locationName');
                        const admName = document.getElementById('admName');
                        
                        if (!userOpenid || !locationName || !admName) {
                            console.error('找不到用户配置元素', {
                                userOpenid: !!userOpenid,
                                locationName: !!locationName,
                                admName: !!admName
                            });
                            alert('找不到必要的用户配置元素');
                            return;
                        }
                        
                        if (!userOpenid.value || !locationName.value || !admName.value) {
                            alert('您选择了双人套餐，但未填写您的个人配置信息');
                            return;
                        }
                        
                        // 保存个人配置到sessionStorage
                        const userConfig = collectUserConfigData(config);
                        if (!userConfig) {
                            alert('用户配置收集失败');
                            return;
                        }
                        sessionStorage.setItem('pendingUserConfig', JSON.stringify(userConfig));
                    }
                    
                    // 保存基本信息到sessionStorage
                    sessionStorage.setItem('pendingPhone', phone);
                    sessionStorage.setItem('pendingConfig', JSON.stringify(config));
                    sessionStorage.setItem('pendingPlan', selectedPlan);
                    
                    // 显示加载中状态
                    document.getElementById('loadingSpinner').style.display = 'block';
                    
                    // 调用创建订单函数
                    createOrder(phone, selectedPlan);
                    
                } catch (error) {
                    console.error('确认订阅处理错误:', error);
                    alert('处理订阅时出错: ' + error.message);
                }
            });
            
            // "我已完成支付"按钮点击事件
            paymentCompleteButton.addEventListener('click', function() {
                // 检查订单状态
                const orderId = sessionStorage.getItem('currentOrderId');
                if (orderId) {
                    checkOrderStatus(orderId);
                }
            });
            
            // 双人套餐选择事件
            document.querySelectorAll('input[name="modal-plan"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const dualConfigSection = document.getElementById('modalUserConfigSection');
                    if (this.value === 'dual') {
                        dualConfigSection.style.display = 'block';
                    } else {
                        dualConfigSection.style.display = 'none';
                    }
                });
            });
            
            // 检查URL参数中是否有支付成功标记
            const urlParams = new URLSearchParams(window.location.search);
            const paymentResult = urlParams.get('payment_result');
            
            if (paymentResult === 'success') {
                paymentSuccess();
                
                // 移除URL参数
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            // 页面加载时设置双人套餐价格为52
            const dualPriceElement = document.getElementById('modalPriceDual');
            if (dualPriceElement) {
                dualPriceElement.textContent = '52';
            }

            // 页面加载时直接设置价格
            document.getElementById('modalPriceMonthly').textContent = '24.9';
            document.getElementById('modalPriceAnnual').textContent = '29.9';
            document.getElementById('modalPriceDual').textContent = '1';
        });
        
        // 改进价格获取函数，增加错误处理和重试逻辑
        function fetchPriceInfo() {
            console.log('正在获取价格信息，API地址:', `${API_BASE_URL}/api/price`);
            
            // 添加时间戳避免缓存问题
            const url = `${API_BASE_URL}/api/price?t=${Date.now()}`;
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                },
                mode: 'cors'  // 明确指定CORS模式
            })
            .then(response => {
                console.log('价格API响应状态:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('获取到的价格数据:', data);
                // 更新模态框中的价格显示
                document.getElementById('modalPriceMonthly').textContent = data.monthly || '24.9';
                document.getElementById('modalPriceAnnual').textContent = data.annual || '29.9';
                document.getElementById('modalPriceDual').textContent = data.dual || '1';
            })
            .catch(error => {
                console.error('获取价格信息失败，使用默认价格:', error);
                // 使用默认价格
                document.getElementById('modalPriceMonthly').textContent = '24.9';
                document.getElementById('modalPriceAnnual').textContent = '29.9';
                document.getElementById('modalPriceDual').textContent = '1';
            });
        }
        
        // 修复显示支付模态框函数
        function showPaymentModal() {
            try {
                console.log('打开支付模态框');
                
                // 重置模态框状态
                const planSelection = document.getElementById('planSelection');
                const qrcodeSection = document.getElementById('qrcodeSection');
                const confirmPaymentButton = document.getElementById('confirmPaymentButton');
                const paymentCompleteButton = document.getElementById('paymentCompleteButton');
                
                if (!planSelection || !qrcodeSection || !confirmPaymentButton || !paymentCompleteButton) {
                    console.error('找不到支付模态框必要元素', {
                        planSelection: !!planSelection,
                        qrcodeSection: !!qrcodeSection,
                        confirmPaymentButton: !!confirmPaymentButton,
                        paymentCompleteButton: !!paymentCompleteButton
                    });
                    alert('初始化支付界面失败，请刷新页面后重试');
                    return;
                }
                
                // 重置模态框状态
                planSelection.style.display = 'block';
                qrcodeSection.style.display = 'none';
                confirmPaymentButton.style.display = 'inline-block';
                paymentCompleteButton.style.display = 'none';
                
                // 显示模态框
                const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));
                paymentModal.show();
                
                console.log('支付模态框已显示');
            } catch (error) {
                console.error('显示支付模态框失败:', error);
                alert('打开支付界面失败: ' + error.message);
            }
        }
        
        // 检查订单状态
        function checkOrderStatus(orderId) {
            fetch(`${API_BASE_URL}/api/payment/check-status?order_id=${orderId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.paid) {
                        // 订单已支付
                        paymentSuccess();
                        paymentModal.hide();
                    } else {
                        alert('订单尚未支付完成，请完成支付后再试');
                    }
                })
                .catch(error => {
                    console.error('检查订单状态失败:', error);
                    alert('检查订单状态失败，请稍后再试');
                });
        }
        
        // 修改支付成功处理函数
        function paymentSuccess() {
            // 隐藏支付相关界面
            document.getElementById('paymentModal').style.display = 'none';
            
            // 获取保存的配置信息
            const phone = sessionStorage.getItem('pendingPhone');
            const plan = sessionStorage.getItem('pendingPlan');
            const orderId = sessionStorage.getItem('currentOrderId');
            
            // 如果是双人套餐，先保存伴侣的配置
            if (plan === 'dual') {
                const partnerConfig = JSON.parse(sessionStorage.getItem('pendingConfig') || '{}');
                
                // 保存伴侣配置
                fetch(`${API_BASE_URL}/api/save-config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: phone,
                        config: partnerConfig,
                        order_id: orderId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('伴侣配置保存成功');
                        
                        // 获取并保存用户自己的配置
                        const userConfig = getUserConfig();
                        
                        // 保存用户自己的配置
                        return fetch(`${API_BASE_URL}/api/save-config`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                phone: phone,
                                config: userConfig,
                                order_id: orderId,
                                is_user: true  // 标记这是用户自己的配置
                            })
                        });
                    } else {
                        throw new Error('保存伴侣配置失败: ' + data.message);
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('用户配置保存成功');
                        showSuccessMessage('配置保存成功，您可以开始使用早安推送服务了！');
                    } else {
                        throw new Error('保存用户配置失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('保存配置失败:', error);
                    showErrorMessage('保存配置失败: ' + error.message);
                });
            } else {
                // 单人套餐，只保存伴侣配置
                const config = JSON.parse(sessionStorage.getItem('pendingConfig') || '{}');
                
                fetch(`${API_BASE_URL}/api/save-config`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: phone,
                        config: config,
                        order_id: orderId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccessMessage('配置保存成功，您可以开始使用早安推送服务了！');
                    } else {
                        showErrorMessage('保存配置失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('保存配置失败:', error);
                    showErrorMessage('保存配置失败: ' + error.message);
                });
            }
        }
        
        // 清除会话存储
        function clearSessionStorage() {
            sessionStorage.removeItem('pendingConfig');
            sessionStorage.removeItem('pendingUserConfig');
            sessionStorage.removeItem('pendingPhone');
            sessionStorage.removeItem('pendingPassword');
            sessionStorage.removeItem('pendingPlan');
            sessionStorage.removeItem('currentOrderId');
        }
        
        // 收集配置信息
        function collectConfigData() {
            return {
                app_id: document.getElementById('app_id').value,
                app_secret: document.getElementById('app_secret').value,
                user_openid: document.getElementById('partner_openid').value,
                template_id: document.getElementById('template_id').value,
                indices_template_id: document.getElementById('indices_template_id').value,
                location_name: document.getElementById('location_name').value,
                adm_name: document.getElementById('adm_name').value,
                meet_date: document.getElementById('meet_date').value,
                partner_birthday: document.getElementById('partner_birthday').value,
                xiazhou_birthday: document.getElementById('xiazhou_birthday').value
            };
        }
        
        // 验证配置信息
        function validateConfig(config) {
            const requiredFields = ['app_id', 'app_secret', 'user_openid', 'template_id', 'location_name', 'adm_name'];
            const missingFields = requiredFields.filter(field => !config[field]);
            
            if (missingFields.length > 0) {
                alert(`请填写必要的配置信息: ${missingFields.join(', ')}`);
                return false;
            }
            
            return true;
        }
        
        // 发送测试消息
        function sendTestMessage(config, isUser) {
            loadingSpinner.style.display = 'block';
            
            console.log(`准备发送测试消息给${isUser ? '您自己' : '伴侣'}:`, config);
            
            // 调用morning_greeting云函数发送测试消息
            fetch(`${MORNING_GREETING_URL}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const recipient = isUser ? '您' : '伴侣';
                    alert(`发送给${recipient}的测试消息成功！`);
                } else {
                    const recipient = isUser ? '您' : '伴侣';
                    alert(`发送给${recipient}的测试消息失败: ${data.message}`);
                }
                loadingSpinner.style.display = 'none';
            })
            .catch(error => {
                console.error('发送测试消息失败:', error);
                const recipient = isUser ? '您' : '伴侣';
                alert(`发送给${recipient}的测试消息失败，请检查配置信息`);
                loadingSpinner.style.display = 'none';
            });
        }
        
        // 保存用户配置
        function saveUserConfig(phone, password, config, plan, isUserConfig) {
            console.log(`保存${isUserConfig ? '用户本人' : '伴侣'}配置到后端:`, {
                phone,
                plan,
                is_user_config: isUserConfig
            });
            
            fetch(`${API_BASE_URL}/api/payment/complete-setup`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    phone: phone,
                    password: password,
                    config: config,
                    plan: plan,
                    order_id: sessionStorage.getItem('currentOrderId'),
                    is_user_config: isUserConfig
                })
            })
            .then(response => response.json())
            .then(result => {
                console.log(`${isUserConfig ? '用户本人' : '伴侣'}配置保存结果:`, result);
            })
            .catch(error => {
                console.error(`保存${isUserConfig ? '用户本人' : '伴侣'}配置失败:`, error);
            });
        }
        
        // 修复收集用户本人的配置信息函数
        function collectUserConfigData(partnerConfig) {
            try {
                // 克隆伴侣配置作为基础
                const userConfig = {...partnerConfig};
                
                // 检查必要的DOM元素是否存在
                const userOpenid = document.getElementById('userOpenid');
                const userTemplateId = document.getElementById('userTemplateId');
                const locationName = document.getElementById('locationName');
                const admName = document.getElementById('admName');
                
                if (!userOpenid || !locationName || !admName) {
                    console.error('找不到必要的用户配置DOM元素');
                    return null;
                }
                
                // 更新用户特定的配置
                userConfig.user_openid = userOpenid.value.trim();
                userConfig.template_id = userTemplateId ? userTemplateId.value.trim() : userConfig.template_id;
                userConfig.location_name = locationName.value.trim();
                userConfig.adm_name = admName.value.trim();
                
                // 交换生日信息
                if (userConfig.xiazhou_birthday && userConfig.partner_birthday) {
                    [userConfig.partner_birthday, userConfig.xiazhou_birthday] = 
                        [userConfig.xiazhou_birthday, userConfig.partner_birthday];
                }
                
                console.log('收集到的用户配置:', userConfig);
                return userConfig;
            } catch (error) {
                console.error('收集用户配置数据时出错:', error);
                alert('收集用户配置失败：' + error.message);
                return null;
            }
        }
        
        // 验证用户配置的函数
        function validateUserConfig(config) {
            if (!config) {
                alert('配置无效，请检查您的输入');
                return false;
            }
            
            if (!config.user_openid) {
                alert('请填写您的微信OpenID');
                return false;
            }
            
            if (!config.location_name) {
                alert('请填写您所在的区/县');
                return false;
            }
            
            if (!config.adm_name) {
                alert('请填写您所在的城市');
                return false;
            }
            
            return true;
        }

        // 完善创建订单函数，添加错误处理
        function createOrder(phone, plan) {
            try {
                console.log('开始创建订单');
                
                // 获取当前显示的价格
                let price;
                const priceMonthly = document.getElementById('modalPriceMonthly');
                const priceAnnual = document.getElementById('modalPriceAnnual');
                const priceDual = document.getElementById('modalPriceDual');
                
                if (!priceMonthly || !priceAnnual || !priceDual) {
                    console.error('找不到价格元素');
                    alert('无法获取价格信息');
                    return;
                }
                
                if (plan === 'monthly') {
                    price = priceMonthly.textContent;
                } else if (plan === 'annual') {
                    price = priceAnnual.textContent;
                } else if (plan === 'dual') {
                    price = priceDual.textContent;
                }
                
                console.log(`创建订单: 套餐=${plan}, 显示价格=${price}`);
                
                // 生成订单并存储信息
                sessionStorage.setItem('pendingPlan', plan);
                
                // 显示加载中状态
                const loadingSpinner = document.getElementById('loadingSpinner');
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'block';
                }
                
                console.log(`调用API: ${API_BASE_URL}/api/payment/create`);
                
                // 调用API创建订单
                fetch(`${API_BASE_URL}/api/payment/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        phone: phone,
                        plan: plan
                    })
                })
                .then(response => {
                    console.log('收到API响应:', response);
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('解析响应数据:', data);
                    
                    // 隐藏加载中状态
                    if (loadingSpinner) {
                        loadingSpinner.style.display = 'none';
                    }
                    
                    if (data.success) {
                        console.log('订单创建成功，支付页面URL:', data.payment_url);
                        console.log('订单ID:', data.order_id);
                        
                        // 存储订单ID
                        sessionStorage.setItem('currentOrderId', data.order_id);
                        
                        // 显示支付二维码
                        const paymentQrcode = document.getElementById('paymentQrcode');
                        const planSelection = document.getElementById('planSelection');
                        const qrcodeSection = document.getElementById('qrcodeSection');
                        const paymentLink = document.getElementById('paymentLink');
                        
                        if (paymentQrcode && planSelection && qrcodeSection && paymentLink) {
                            paymentQrcode.src = data.qrcode_url || 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(data.payment_url);
                            planSelection.style.display = 'none';
                            qrcodeSection.style.display = 'block';
                            
                            // 提供支付链接
                            paymentLink.href = data.payment_url;
                            paymentLink.style.display = 'block';
                            
                            // 检查支付状态
                            checkPaymentStatus(data.order_id);
                        } else {
                            console.error('找不到支付界面元素');
                            alert('显示支付信息失败，请刷新页面重试');
                        }
                    } else {
                        alert('创建订单失败: ' + (data.message || '未知错误'));
                        console.error('创建订单失败:', data);
                    }
                })
                .catch(error => {
                    // 隐藏加载中状态
                    if (loadingSpinner) {
                        loadingSpinner.style.display = 'none';
                    }
                    
                    alert('创建订单发生错误，请稍后再试: ' + error.message);
                    console.error('创建订单错误:', error);
                });
            } catch (error) {
                console.error('创建订单函数错误:', error);
                alert('创建订单出错: ' + error.message);
                
                // 隐藏加载中状态
                const loadingSpinner = document.getElementById('loadingSpinner');
                if (loadingSpinner) {
                    loadingSpinner.style.display = 'none';
                }
            }
        }

        // 添加在fetchPriceInfo函数后
        function testApiWithoutCors() {
            // 创建一个脚本标记
            var script = document.createElement('script');
            script.src = `${API_BASE_URL}/api/price?callback=handlePriceData&t=${Date.now()}`;
            document.head.appendChild(script);
        }

        // 接收JSONP回调数据
        function handlePriceData(data) {
            console.log('通过JSONP获取的价格数据:', data);
            if (data) {
                document.getElementById('modalPriceMonthly').textContent = data.monthly || '24.9';
                document.getElementById('modalPriceAnnual').textContent = data.annual || '29.9';
                document.getElementById('modalPriceDual').textContent = data.dual || '1';
            }
        }

        // 页面加载时尝试获取价格
        document.addEventListener('DOMContentLoaded', function() {
            // 首先尝试正常获取
            fetchPriceInfo();
            
            // 如果5秒内没有成功，使用JSONP方式再试一次
            setTimeout(function() {
                if (document.getElementById('modalPriceDual').textContent === '1') {
                    console.log('常规获取失败，尝试JSONP方式');
                    testApiWithoutCors();
                }
            }, 5000);
        });

        // 更新获取用户配置的函数，增加模板ID字段
        function getUserConfig() {
            const userConfig = {
                user_openid: document.getElementById('userOpenid').value.trim(),
                template_id: document.getElementById('userTemplateId').value.trim(), // 添加模板ID
                location_name: document.getElementById('locationName').value.trim(),
                adm_name: document.getElementById('admName').value.trim(),
                tz_offset: "Asia/Shanghai",  // 默认使用上海时区
                language: "zh",  // 默认使用中文
                weather: true,  // 默认开启天气
                date_format: "YYYY-MM-DD",  // 默认日期格式
                
                // 其他配置参数
                nickname: document.getElementById('nickname').value.trim() || "我",
                partner_nickname: document.getElementById('partnerNickname').value.trim() || "伴侣",
                holidays: true,  // 默认开启节假日提醒
                countdown_type: "anniversary"  // 默认倒计时类型
            };
            
            return userConfig;
        }
    </script>
    
    <!-- 51LA统计代码 - 放在body结束标签前 -->
    <script type="text/javascript" src="//js.users.51.la/21954557.js"></script>
</body>
</html> 
